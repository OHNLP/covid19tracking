<!doctype html>
<html lang="en">

<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="icon" href="./static/img/favicon.ico">
<title>COVID-19 Dashboard</title>
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
<script src="https://kit.fontawesome.com/cb45cc91b0.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css" />
<style>
html, body {
    overflow: hidden;
    font-size: 12px;
}
p {
    margin-bottom: .5rem;
}
.box-header-nav {
    padding: 0 0 0 15px;
}
/* a start screen for IE and hiding init */
#start-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}
.wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
}
.d3-tip {
    line-height: 1;
    padding: 6px;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    border-radius: 4px;
    font-size: 12px;
}
/* for the calendar chart */
.fig-crrw-calendar {
    width: 100%;
    height: 95px;
}
.fig-crrw-calendar .crrw-day-label {
    display: inline-block;
    width: 80px;
    margin: 0 5px 1px 0 ;
    font-size: 10px;
}
.fig-crrw-calendar .crrw-day-chart {
    width: calc(100% - 80px);
    height: 105px;
}
/* for the 1-d calendar chart */
.fig-crrw-1dcal {
    height: 12px;
    width: 100%;
    padding: 0 0 0 5px;
}
.fig-crrw-1dcal:hover {
    background: whitesmoke;
}
.fig-crrw-1dcal .crrw-day-label {
    display: inline-block;
    width: 80px;
    height: 12px;
    margin: 0 5px 1px 0 ;
    overflow: hidden;
    white-space: nowrap;
    font-size: 10px;
    line-height: 12px;
}
.fig-crrw-1dcal .crrw-day {
    display: inline-block;
    width: 6px;
    height: 6px;
    margin: 0 1px 1px 0 ;
}
/* for the trend chart */
.fig-crrw-trend {
    width: 100%;
    height: 165px;
    margin: 0 0 3px 0;
    background: white;
}
.crrw-trend-info {
    display: inline-block;
    width: 80px;
    padding: 0 0 0 5px;
}
.crrw-trend-bar {
    display: block;
    width: 100%;
    padding: 2px 0;
}
.crrw-trend-label {
    display: inline-block;
    width: 100%;
}
.crrw-trend-label:hover {
    cursor: grab;
    cursor: -moz-grab;
    cursor: -webkit-grab;
    background: whitesmoke;
}
.crrw-trend-label:active {
    cursor: grabbing;
    cursor: -moz-grabbing;
    cursor: -webkit-grabbing;
    background: whitesmoke;
}
.crrw-trend-chart {
    width: 100%;
    min-width: 600px;
    height: 150px;
}
.crrw-day-R,
.crrw-day-2 {
    background: red;
}
.crrw-day-G,
.crrw-day-0 {
    background: green;
}
.crrw-day-Y,
.crrw-day-1 {
    background: gold;
}
.crrw-day-badge {
    padding: 1px 5px;
    border-radius: 5px;
}
#header {
    background: whitesmoke;
}
#header a {
    color: #555555;
}
.modal-dialog {
    max-width: 900px !important;
}
.attr-color-legend {
    display: inline-block;
    width: 50px;
    height: 16px;
}
.region-detail-box {
    width: 100%;
    max-height: 150px;
    border-top: 1px dotted #eeeeee;
    padding: 5px;
}
.region-detail-item {
    display: inline-block;
    margin: 0 10px 0 0;
}
.region-detail-name {
    background: #ececec;
    padding: 0 3px;
    border-bottom: 1px solid #ececec;
}
.region-detail-value {
    font-weight: bold;
    margin-left: -3px;
    padding: 0 3px;
    border-bottom: 1px solid #ececec;
}
</style>
</head>

<body>

    
<div id="start-screen">
    <h1>
        <i class="fa fa-globe-americas"></i>
        COVID-19 Dashboard
    </h1>
    <div id="ss-msg">Loading data and initializing plots ...</div>
</div>

<div class="container-fluid wrapper">
    <div id="header" class="row mb-3">
        <div class="col">
            <div class="mt-2 mb-2">
                <i class="fa fa-globe-americas"></i> <b>COVID-19 Dashboard</b> |
                <a href="./"><i class="fa fa-home"></i> Home</a> |
                <a target="_blank" href="./cdtmap_county.html"><i class="fa fa-map"></i> U.S. County CDT Animated Map</a> |
                <a target="_blank" href="./cdtmap_state.html"><i class="fa fa-map"></i> U.S. State CDT Animated Map</a> |
                <a target="_blank" href="./cdtmap_world.html"><i class="fa fa-map"></i> World CDT Animated Map</a> |
                <a href="javascript:void(0);" 
                    onclick="jarvis.modal('About CrRW and how to use this website',$('#about-text').html());">
                    <i class="fa fa-question-circle"></i>
                    About
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col d-flex flex-column">
            <div class="d-flex flex-row">
                <h5>
                    <i class="far fa-calendar-alt"></i>
                    CrRW Calendar for <span id="fig_crrw_calendars_region">&nbsp;</span>
                </h5>
                <div class="form-inline ml-3">
                    <button type="button" class="btn btn-light btn-sm mr-2 "
                        onclick="jarvis.play();">
                        <i class="fa fa-play"></i>
                        Play
                    </button>
                    <button type="button" class="btn btn-light btn-sm mr-2 "
                        onclick="jarvis.stop();">
                        <i class="fa fa-stop"></i>
                        Stop
                    </button>
                </div>
            </div>
            <div id="fig_crrw_calendars" class="box" style="width: 100%;">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col d-flex flex-row">

            <div id="fig_crrw_worldmap_vpp" class="box" style="max-width: 600px;">
                <h5>
                    <i class="fa fa-globe-americas"></i>
                    World Status for <span id="fig_crrw_worldmap_last_update">&nbsp;</span>
                </h5>
                <div>
                    <div class="btn-group">
                        <button id="fig_crrw_worldmap_select_colorscale"
                            class="btn btn-light btn-sm dropdown-toggle" 
                            type="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            Color: {{ attr_colorscales[current.attr].name }}
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" 
                                href="javascript:void(0);"
                                v-for="attr_colorscale, attr in attr_colorscales"
                                v-on:click="update_color(attr)">
                                <span class="attr-color-legend" 
                                    v-bind:style="get_attr_colorscale_legend(attr_colorscale)">
                                    &nbsp;
                                </span>
                                {{ attr_colorscale.name }}
                            </a>
                        </div>
                    </div>
                </div>
                <div id="fig_crrw_worldmap" style="width: 560px; height: 300px;"></div>

                <div class="region-detail-box" v-if="country.country == null"></div>
                <div class="region-detail-box" v-else>
                    <p>For {{ date }}, {{ country.data.name }}, (Population: {{ fmt_comma(country.data.pop) }}). </p>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Cr7d100k:</span>
                        <span class="region-detail-value">{{ get_detail().crp }} cases per 100k capita</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">RW_Cr7d100k:</span>
                        <span class="region-detail-value">{{ get_detail().crt }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">New cases:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().dnc) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total cases:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().ncc) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Case Doubling Time:</span>
                        <span class="region-detail-value">{{ (get_detail().cdt).toFixed(1) }} days</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total death:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().dth) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Death rate:</span>
                        <span class="region-detail-value">{{ (get_detail().dtr*100).toFixed(2) }} %</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total Cases / Population:</span>
                        <span class="region-detail-value">{{ (get_detail().tcp*100).toFixed(4) }} %</span>
                    </div>
                </div>
            </div>
            
            <div id="fig_crrw_usmap_vpp" class="box" style="max-width: 500px;">

                <h5>
                    <i class="fa fa-globe-americas"></i>
                    U.S. Status for <span id="fig_crrw_usmap_last_update">&nbsp;</span>
                </h5>
                <div>
                    <div class="btn-group">
                        <button id="fig_crrw_usmap_select_colorscale"
                            class="btn btn-light btn-sm dropdown-toggle" 
                            type="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            Color: {{ attr_colorscales[current.attr].name }}
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" 
                                href="javascript:void(0);"
                                v-for="attr_colorscale, attr in attr_colorscales"
                                v-on:click="update_color(attr)">
                                <span class="attr-color-legend" 
                                    v-bind:style="get_attr_colorscale_legend(attr_colorscale)">
                                    &nbsp;
                                </span>
                                {{ attr_colorscale.name }}
                            </a>
                        </div>
                    </div>
                </div>

                <div id="fig_crrw_usmap" style="width: 460px; height: 300px;"></div>

                <div class="region-detail-box" v-if="state.state == null"></div>
                <div class="region-detail-box" v-else>
                    <p>For {{ date }}, {{ state.data.name }}, (Population: {{ fmt_comma(state.data.pop) }}). </p>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Cr7d100k:</span>
                        <span class="region-detail-value">{{ get_detail().crp }} cases per 100k capita</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">RW_Cr7d100k:</span>
                        <span class="region-detail-value">{{ get_detail().crt }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Pandemic Vulnerability Index:</span>
                        <span class="region-detail-value">{{ get_detail().pvi.toFixed(2) }} (Median)</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">New cases:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().dnc) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total cases:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().ncc) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Case Doubling Time:</span>
                        <span class="region-detail-value">{{ (get_detail().cdt).toFixed(1) }} days</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total death:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().dth) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Death rate:</span>
                        <span class="region-detail-value">{{ (get_detail().dtr*100).toFixed(2) }} %</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total Cases / Population:</span>
                        <span class="region-detail-value">{{ (get_detail().tcp*100).toFixed(4) }} %</span>
                    </div>
                </div>
            </div>


            <div id="fig_crrw_stmap_vpp" class="box" style="max-width: 500px;">
                <h5>
                    <i class="fa fa-map"></i>
                    <span id="fig_crrw_stmap_state_name">&nbsp;</span>
                    State Status 
                    for <span id="fig_crrw_stmap_last_update">&nbsp;</span>
                </h5>
                <div>
                    <div class="btn-group">
                        <button id="fig_crrw_stmap_select_colorscale"
                            class="btn btn-light btn-sm dropdown-toggle" 
                            type="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            Color: {{ attr_colorscales[current.attr].name }}
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" 
                                href="javascript:void(0);"
                                v-for="attr_colorscale, attr in attr_colorscales"
                                v-on:click="update_color(attr)">
                                <span class="attr-color-legend" 
                                    v-bind:style="get_attr_colorscale_legend(attr_colorscale)">
                                    &nbsp;
                                </span>
                                {{ attr_colorscale.name }}
                            </a>
                        </div>
                    </div>
                </div>
                <div id="fig_crrw_stmap" style="width: 330px; height: 300px;"></div>

                <div class="region-detail-box" v-if="county.fips == null"></div>
                <div class="region-detail-box" v-else>
                    <p>For {{ date }}, {{ county.data.name }}, {{ county.data.state }} (Population: {{ fmt_comma(county.data.pop) }}). </p>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Cr7d100k:</span>
                        <span class="region-detail-value">{{ get_detail().crp }} cases per 100k capita</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">RW_Cr7d100k:</span>
                        <span class="region-detail-value">{{ get_detail().crt }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Pandemic Vulnerability Index:</span>
                        <span class="region-detail-value">{{ get_detail().pvi.toFixed(2) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">New cases:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().dnc) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total cases:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().ncc) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Case Doubling Time:</span>
                        <span class="region-detail-value">{{ (get_detail().cdt).toFixed(1) }} days</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total death:</span>
                        <span class="region-detail-value">{{ fmt_comma(get_detail().dth) }} </span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Death rate:</span>
                        <span class="region-detail-value">{{ (get_detail().dtr*100).toFixed(2) }} %</span>
                    </div>
                    <div class="region-detail-item" >
                        <span class="region-detail-name">Total Cases / Population:</span>
                        <span class="region-detail-value">{{ (get_detail().tcp*100).toFixed(4) }} %</span>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- <div class="row">
        <div class="col">
            <div class="box">
                <h5>
                    <i class="fa fa-calendar-alt"></i>
                    CrRW Status Calendar
                </h5>
                <div id="fig_crrw_calendars" style="width: 100%;">

                </div>
            </div>
        </div>
    </div> -->

    <div class="row">
        <div class="col">
            <div class="box">
                <div class="box-header d-flex">
                    <h5>
                        <i class="fa fa-line-chart"></i>
                        CrRW Status Trend
                    </h5>
                    <div class="box-header-nav d-flex">
                        <div class="form-inline">
                            <button type="button" class="btn btn-light btn-sm mr-2 "
                                onclick="jarvis.reset_fig_crrw_trends();">
                                <i class="fa fa-undo"></i>
                                Reset
                            </button>
                        </div>

                        <!-- <div class="form-inline">
                            <input id="input_fips" type="text" 
                                class="form-control mr-2 mr-sm-2" 
                                placeholder="FIPS or State">
                            <button type="button" class="btn btn-primary btn-sm"
                                onclick="jarvis.add_trend();">
                                <i class="fa fa-plus"></i>
                                Add
                            </button>
                        </div> -->
                    </div>
                </div>
                <div id="fig_crrw_trends" style="width: 100%;">

                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" style="position: absolute; top: 10px; right: 10px;">
        <div class="toast-header">
            <svg class="bd-placeholder-img rounded mr-2" width="15" height="15" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice" focusable="false" role="img"><rect id="toast_rect" width="100%" height="100%" fill="#007aff"></rect></svg>
            <strong class="mr-auto">Bootstrap</strong>
            <small>&nbsp;</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div id="toast_body" class="toast-body">
            &nbsp;
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="modal-title">Modal title</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div id="modal-body" class="modal-body">
            
            </div>
        </div>
        </div>
    </div>

    <div id="about-text" style="display: none;">
    <style>
    .rcf-em1 {
        font-weight: bold;
        background-color: whitesmoke;
        border-radius: 5px;
        padding: 0 3px;
    }
    </style>
    <h5>CrRW: Cr7d100k and RW_Cr7d100k</h5>
    <p>CrRW is a novel method to measure the trends in COVID-19 or other infectious diseases, which includes two indicators: </p>
    <p>1. <b>Cr7d100k</b>: 7-day smoothed average daily case rate per 100k capita;</p>
    <p>2. <b>RW_Cr7d100k</b>: the ratio of this week’s Cr7d100k comparing to the week before.</p>
    <p>The data for calculating CrRW are from USAFacts and COVIDTracking.</p>
    <p>By using these two indicators in combination, we can depict the current status of the epidemic as well as recent trends with following thresholds:</p>
    <p>1. The <b class="badge badge-success">GREEN</b> status: There are two cases. First, if <span class="rcf-em1">Cr7d100k <= 10</span> for the past seven days, it would be safe. Second, if <span class="rcf-em1">Cr7d100k < 15 and RW_Cr7d100k < 1</span> for the past seven days, it would be relative safe; </p>
    <p>2. The <b class="badge badge-danger">RED</b> status: There are two cases. First, if <span class="rcf-em1">Cr7d100k > 30</span> for the past seven days, the pandemic is extremely serious. Second, if <span class="rcf-em1">Cr7d100k > 10 and RW_Cr7d100k > 1</span> and for the past seven days, the current pandemic situation is bad or the trend is bad;</p>
    <p>3. The <b class="badge badge-warning">ORANGE</b> status: Everything else is orange status as we cannot say much – it can go either way.</p>
    <hr>
    <h5>Pandemic Vulnerability Index</h5>
    <p>The Pandemic Vulnerability Index (PVI) is an indicator which integrates baseline data on relevant community vulnerabilities with dynamic data on local infection rates and interventions <a target="_blank" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7430608/">PMID: 32817964</a>. The data of PVI model are from <a target="_blank" href="https://covid.cdc.gov/covid-data-tracker/#pandemic-vulnerability-index">CDC COVID Data Tracker</a>.</p>
    <hr>
    <h5>How to use this website?</h5>
    <p>Click on the states and counties to see the CrRW status trend.</p>
    <p><img src="./static/img/crrw-demo.gif" alt="Demonstrating how to use this website"></p>
</div>
</div>

<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The visualization used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer.<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers to access:<br><span style="font-size:1.2em;">' + location.href + '</span>';
}
</script>
<!-- JavaScript packages -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@4.5.0/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>

<script>

var fig_crrw_worldmap = {
    plot_id: 'fig_crrw_worldmap',
    vpp: null,
    vpp_id: '#fig_crrw_worldmap_vpp',

    data: null,
    data_file: 'world-fc-history.json',
    colorscale: {
        cdts: {
            name: 'Case Doubling Time',
            min: 0,
            mid: 50,
            max: 100,
            schema: [
                [0, 'rgba(255, 0, 0, 1)'],
                [0.5, 'rgba(255, 255, 0, 1)'],
                [1, 'rgba(144, 238, 144, 1)']
            ]
        },
        crcs: {
            name: 'CrRW Status',
            min: 0,
            mid: 1,
            max: 2,
            schema: [
                [0, 'green'],
                [0.5, 'gold'],
                [1, 'red']
            ]
        },
        tcps: {
            name: 'Total Cases / Population',
            min: 0,
            mid: 0.03,
            max: 0.06,
            schema: [
                [0,   'rgba(254, 240, 206, 1)'],
                [0.5, 'rgba(253, 164, 93, 1)'],
                [1, 'rgba(255, 30, 2, 1)']
            ]
        },
        // pvis: {
        //     name: 'Pandemic Vulnerability Index',
        //     min: 0,
        //     mid: 0.5,
        //     max: 1,
        //     schema: [
        //         [0,   'rgba(253, 231, 228, 1)'],
        //         [0.5, 'rgba(240, 90, 158, 1)'],
        //         [1, 'rgba(71, 1, 103, 1)']
        //     ]
        // }
    },
    fmt_comma: d3.format(","),

    plot_config: {
        responsive: true,
        // displayModeBar: false,
        scrollZoom: false,
    },

    current: {
        date: null,
        attr: 'crcs'
    },

    load: function() {
        $.get(
            './covid_data/state/' + this.data_file,
            {ver: Math.random()},
            function(data) {
                fig_crrw_worldmap.init(data);
            }, 'json'
        );
    },

    init: function() {
        // init the vpp part
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                attr_colorscales: this.colorscale,
                current: this.current,
                date: null,
                dates: [],
                country: {
                    country: null,
                    data: {}
                }
            },
            methods: {
                get_attr_colorscale_legend: function(attr_colorscale) {
                    var style = "background: linear-gradient(90deg";
                    for (var i = 0; i < attr_colorscale.schema.length; i++) {
                        var schema_item = attr_colorscale.schema[i];
                        style += ', ' + schema_item[1] + ' ' + (schema_item[0] * 100) + '%'
                    } 
                    style += ');'
                    return style;
                },

                update_color: function(attr) {
                    this.current.attr = attr;
                    fig_crrw_worldmap.update(fig_crrw_worldmap.data);
                },

                get_detail: function() {
                    var date_idx = this.dates.indexOf(this.date);
                    return {
                        country: this.country.data.country,
                        name: this.country.data.name,
                        state: this.country.data.state,
                        pop: this.country.data.pop,
                        cdt: this.country.data.cdts[date_idx],
                        crp: this.country.data.crps[date_idx],
                        crt: this.country.data.crts[date_idx],
                        ncc: this.country.data.nccs[date_idx],
                        dnc: this.country.data.dncs[date_idx],
                        dth: this.country.data.dths[date_idx],
                        dtr: this.country.data.dtrs[date_idx],
                        crc: this.country.data.crcs[date_idx],
                        tcp: this.country.data.nccs[date_idx] / this.country.data.pop
                    }
                },

                fmt_comma: function(v) {
                    return fig_crrw_worldmap.fmt_comma(v);
                }
            }
        });
    },

    update: function(data) {
        this.data = data;
        this.current.date = data.date;
    
        // update the vpp
        this.vpp.date = data.date;
        this.vpp.dates = data.dates;
        
        this._create_plot_data();
        this._create_plot_layout();

        Plotly.purge(this.plot_id);
        Plotly.newPlot(
            this.plot_id, 
            this.plot_data,
            this.plot_layout,
            this.plot_config
        );
        // update the last update
        $('#' + this.plot_id + '_last_update').html(data.date);

        // re-bind click event
        this._bind_click_event();

        // re-bind hover event
        this._bind_hover_event();
    },

    update_by_date: function(date) {
        this.current.date = date;

        // update hte vpp
        this.vpp.date = date;
        
        // create the data on this date
        var mydata = this._create_mydata();

        var update_plot_data = [{
            locations: this.unpack(mydata, 'country'),
            text: this.unpack(mydata, 'txt'),
            z: this.unpack(mydata, 'val'),
        }];
        
        // update the figure
        Plotly.animate(
            this.plot_id,
            {
                data: update_plot_data,
                traces: [0],
                layout: {},
            },
            {
                transition: {
                    duration: 100,
                    easing: "cubic-in-out",
                },
                frame: {
                    duration: 100,
                },
            }
        );

        // update hte last update time
        $('#' + this.plot_id + '_last_update').html(this.current.date);
    },

    _bind_click_event: function() {
        // bind click events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_click', function(data) {
            var country = data.points[0].location;
            jarvis.show_country(country);
            fig_crrw_worldmap.show_detail(country)
        });
    },

    _bind_hover_event: function() {
        // bind hover events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_hover', function(data) {
            var country = data.points[0].location;
        });
    },


    show_detail: function(country) {
        this.vpp.country.country = country;
        this.vpp.country.data = this.data.world_data[country];
        // this.vpp.$forceUpdate();
    },

    _create_mydata: function() {
        var date = this.current.date;
        var date_idx = this.data.dates.indexOf(date);
        var rows = this.data.world_data;
        var mydata = [];

        for (var country in rows) {
            if (rows.hasOwnProperty(country)) {
                var obj = rows[country];
                var country_name = obj.name;
                var cdt = obj.cdts[date_idx];
                var dnc = obj.dncs[date_idx];
                var ncc = obj.nccs[date_idx];
                var crp = obj.crps[date_idx];
                var crt = obj.crts[date_idx];
                var dth = obj.dths[date_idx];
                var dtr = obj.dtrs[date_idx];
                var crc = obj.crcs[date_idx];
                var crc_v = {R:2, Y:1, G:0}[crc];
                var tcp = ncc / obj.pop;

                // decide show which value as default
                var val = null;
                if (this.current.attr == 'crcs') {
                    val = crc_v;
                } else if (this.current.attr == 'tcps') {
                    val = tcp;
                } else {
                    val = obj[this.current.attr][obj[this.current.attr].length - 1];
                }
                var r = {
                    country: country,
                    val: val,
                    txt: country_name + '<br>' +
                        // ' (Population: ' + this.fmt_comma(obj.pop) + ')     <br>' +
                        // 'For ' + date + ' <br>' +
                        // 'Cr7d100k: <b>' + crp.toFixed(1) + ' cases per 100k </b><br>' +
                        // 'RW_Cr7d100k: <b>' + crt.toFixed(2) + ' </b><br>' +
                        // 'CDT: <b>' + cdt.toFixed(1) + ' days </b><br>' +
                        // 'New Cases: <b>' + this.fmt_comma(dnc) + ' </b><br>' + 
                        'Total Cases: <b>' + this.fmt_comma(ncc) + ' </b><br>' + 
                        // 'Total Cases/Population: <b>' + (tcp*100).toFixed(4) + '% </b><br>' + 
                        // 'Total Death: <b>' + this.fmt_comma(dth) + ' </b><br>' + 
                        // 'Death Rate: <b>' + (dtr*100).toFixed(2) + '%</b><br>' +
                        ''
                };
                mydata.push(r);
            }
        }

        this._mydata = mydata;

        return mydata;
    },
    
    _create_plot_data: function() {
        var mydata = this._create_mydata();

        this.plot_data = [];
        this.plot_data.push({
            name: '',
            type: 'choropleth',
            locationmode: 'world',

            locations: this.unpack(mydata, 'country'),
            text: this.unpack(mydata, 'txt'),
            z: this.unpack(mydata, 'val'),

            showlegend: false,
            showscale: false,

            hovertemplate: '%{text}',
            zmin: this.colorscale[this.current.attr].min,
            zmax: this.colorscale[this.current.attr].max,

            colorscale: this.colorscale[this.current.attr].schema,

            hoverlabel: {
                font: {
                    size: 12
                },
                align: 'left'
            }
        });
    },

    _create_plot_layout: function() {
        this.plot_layout = {
            margin: { t: 0 , b: 0, l: 0, r: 0},
            geo: {
                scope: 'world',
                resolution: 50,
                showframe: false,
                showlakes: false
            },
            width: this.get_width(),
            height: this.get_height()
        };
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    },


    get_width: function() {
        var w = $('#' + this.plot_id).css('width');
        w = parseFloat(w.substring(0, w.length-2));
        console.log('* ' + this.plot_id + ' width: ' + w);
        
        var widths = [];
        if (w < 100) {
            // ask help !!!
            // 40 is the padding of the container
            w = jarvis.guess_width(this.plot_id) - 40;
            if (w == 0) {
                w = this.default_width;
            }
        }

        return w;
    },

    get_height: function() {
        var h = $('#' + this.plot_id).css('height');
        h = parseFloat(h.substring(0, h.length-2));
        console.log('* ' + this.plot_id + ' height: ' + h);

        if (h < 200) {
            var width = this.get_width();
            return width * 0.5;
        } else {
            return h;
        }

    },

};
// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_crrw_worldmap.plot_id] = fig_crrw_worldmap;
}
var fig_crrw_usmap = {
    plot_id: 'fig_crrw_usmap',
    vpp: null,
    vpp_id: '#fig_crrw_usmap_vpp',

    data: null,
    data_file: 'US-latest.json',
    colorscale: {
        cdts: {
            name: 'Case Doubling Time',
            min: 0,
            mid: 50,
            max: 100,
            schema: [
                [0, 'rgba(255, 0, 0, 1)'],
                [0.5, 'rgba(255, 255, 0, 1)'],
                [1, 'rgba(144, 238, 144, 1)']
            ]
        },
        crcs: {
            name: 'CrRW Status',
            min: 0,
            mid: 1,
            max: 2,
            schema: [
                [0, 'green'],
                [0.5, 'gold'],
                [1, 'red']
            ]
        },
        tcps: {
            name: 'Total Cases / Population',
            min: 0,
            mid: 0.03,
            max: 0.06,
            schema: [
                [0,   'rgba(254, 240, 206, 1)'],
                [0.5, 'rgba(253, 164, 93, 1)'],
                [1, 'rgba(255, 30, 2, 1)']
            ]
        },
        pvis: {
            name: 'Pandemic Vulnerability Index',
            min: 0.3,
            mid: 0.5,
            max: 0.7,
            schema: [
                [0,   'rgba(253, 231, 228, 1)'],
                [0.5, 'rgba(240, 90, 158, 1)'],
                [1, 'rgba(71, 1, 103, 1)']
            ]
        }
    },
    fmt_comma: d3.format(","),

    current: {
        date: null,
        attr: 'crcs'
    },

    plot_config: {
        responsive: true,
        // displayModeBar: false,
        scrollZoom: false,
    },

    load: function() {
        $.get(
            './covid_data/state/' + this.data_file,
            {ver: Math.random()},
            function(data) {
                fig_crrw_usmap.init(data);
            }, 'json'
        );
    },

    init: function() {
        // init the vpp part
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                attr_colorscales: this.colorscale,
                current: this.current,
                date: null,
                dates: [],
                state: {
                    state: null,
                    data: {}
                }
            },
            methods: {
                get_attr_colorscale_legend: function(attr_colorscale) {
                    var style = "background: linear-gradient(90deg";
                    for (var i = 0; i < attr_colorscale.schema.length; i++) {
                        var schema_item = attr_colorscale.schema[i];
                        style += ', ' + schema_item[1] + ' ' + (schema_item[0] * 100) + '%'
                    } 
                    style += ');'
                    return style;
                },

                update_color: function(attr) {
                    this.current.attr = attr;
                    fig_crrw_usmap.update(fig_crrw_usmap.data);
                },

                get_detail: function() {
                    var date_idx = this.dates.indexOf(this.date);
                    return {
                        state: this.state.data.state,
                        name: this.state.data.name,
                        state: this.state.data,
                        pop: this.state.data.pop,
                        cdt: this.state.data.cdts[date_idx],
                        crp: this.state.data.crps[date_idx],
                        crt: this.state.data.crts[date_idx],
                        ncc: this.state.data.nccs[date_idx],
                        dnc: this.state.data.dncs[date_idx],
                        dth: this.state.data.dths[date_idx],
                        dtr: this.state.data.dtrs[date_idx],
                        crc: this.state.data.crcs[date_idx],
                        pvi: this.state.data.pvis[date_idx],
                        tcp: this.state.data.nccs[date_idx] / this.state.data.pop
                    }
                },

                fmt_comma: function(v) {
                    return fig_crrw_usmap.fmt_comma(v);
                }
            }
        });
    },

    update: function(data) {
        this.data = data;
        this.current.date = data.date;

        // update the vpp
        this.vpp.date = data.date;
        this.vpp.dates = data.dates;

        this._create_plot_data();
        this.plot_layout = {
            margin: { t: 0 , b: 0, l: 0, r: 0},
            geo: {
                scope: 'usa',
                showlakes: true,
                lakecolor: 'rgb(255,255,255)'
            }
        };

        Plotly.purge(this.plot_id);
        Plotly.newPlot(
            this.plot_id, 
            this.plot_data,
            this.plot_layout,
            this.plot_config
        );

        // re-bind click event
        this._bind_click_event();

        // re-bind hover event
        this._bind_hover_event();

        // update the last update
        $('#' + this.plot_id + '_last_update').html(data.date);
    },

    update_by_date: function(date) {
        this.current.date = date;

        // update hte vpp
        this.vpp.date = date;
        
        // create the data on this date
        var mydata = this._create_mydata();
        var update_plot_data = [{
            locations: this.unpack(mydata, 'state'),
            text: this.unpack(mydata, 'txt'),
            z: this.unpack(mydata, 'val'),
        }];
        
        // update the figure
        Plotly.animate(
            this.plot_id,
            {
                data: update_plot_data,
                traces: [0],
                layout: {},
            },
            {
                transition: {
                    duration: 100,
                    easing: "cubic-in-out",
                },
                frame: {
                    duration: 100,
                },
            }
        );

        // update hte last update time
        $('#' + this.plot_id + '_last_update').html(this.current.date);
    },

    _bind_click_event: function() {
        // bind click events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_click', function(data) {
            var state = data.points[0].location;
            jarvis.show_state(state);
            fig_crrw_usmap.show_detail(state)
        });
    },

    _bind_hover_event: function() {
        // bind hover events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_hover', function(data) {
            var state = data.points[0].location;
            // jarvis.show_state(state);
        });
    },


    show_detail: function(state) {
        // console.log('* show detail: ' + county_fips);
        this.vpp.state.state = state;
        this.vpp.state.data = this.data.state_data[state];
        // this.vpp.$forceUpdate();
    },

    _create_mydata: function() {
        var date = this.current.date;
        var date_idx = this.data.dates.indexOf(date);
        var rows = this.data.state_data;
        var mydata = [];

        for (var state in rows) {
            if (rows.hasOwnProperty(state)) {
                var obj = rows[state];
                var cdt = obj.cdts[date_idx];
                var ncc = obj.nccs[date_idx];
                var dnc = obj.dncs[date_idx];
                var crp = obj.crps[date_idx];
                var crt = obj.crts[date_idx];
                var dth = obj.dths[date_idx];
                var dtr = obj.dtrs[date_idx];
                var pvi = obj.pvis[date_idx];
                var crc = obj.crcs[date_idx];
                var crc_v = {R:2, Y:1, G:0}[crc];
                var tcp = ncc / obj.pop;

                // decide show which value as default
                var val = null;
                if (this.current.attr == 'crcs') {
                    val = crc_v;
                } else if (this.current.attr == 'tcps') {
                    val = tcp;
                } else {
                    val = obj[this.current.attr][obj[this.current.attr].length - 1];
                }

                var r = {
                    state: state,
                    val: val,
                    txt: obj.name + '<br>' +
                        // ' (Population: ' + this.fmt_comma(obj.pop) + ') <br>'+
                        // 'For ' + date + ' <br>' +
                        // 'Cr7d100k: <b>' + crp.toFixed(1) + ' cases per 100k </b><br>' +
                        // 'RW_Cr7d100k: <b>' + crt.toFixed(2) + ' </b><br>' +
                        // 'CDT: <b>' + cdt.toFixed(1) + ' days </b><br>' +
                        // 'New Cases: <b>' + this.fmt_comma(dnc) + '</b><br>' +
                        'Total Cases: <b>' + this.fmt_comma(ncc) + ' </b><br>' + 
                        // 'Total Cases/Population: <b>' + (tcp*100).toFixed(4) + '% </b><br>' + 
                        // 'Total Death: <b>' + this.fmt_comma(dth) + ' </b><br>' + 
                        // 'Death Rate: <b>' + (dtr*100).toFixed(2) + '%</b><br>'
                        ''
                };
                mydata.push(r);
            }
        }

        return mydata;
    },
    
    _create_plot_data: function() {
        
        var mydata = this._create_mydata();
        this.plot_data = [];
        this.plot_data.push({
            name: '',
            type: 'choropleth',
            locationmode: 'USA-states',

            locations: this.unpack(mydata, 'state'),
            text: this.unpack(mydata, 'txt'),
            z: this.unpack(mydata, 'val'),

            showlegend: false,
            showscale: false,

            hovertemplate: '%{text}',
            zmin: this.colorscale[this.current.attr].min,
            zmax: this.colorscale[this.current.attr].max,

            colorscale: this.colorscale[this.current.attr].schema,

            hoverlabel: {
                font: {
                    size: 12
                },
                align: 'left'
            }
        });
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    },


    get_width: function() {
        var w = $('#' + this.plot_id).css('width');
        w = parseFloat(w.substring(0, w.length-2));
        console.log('* ' + this.plot_id + ' width: ' + w);
        
        var widths = [];
        if (w < 100) {
            // ask help !!!
            // 40 is the padding of the container
            w = jarvis.guess_width(this.plot_id) - 40;
            if (w == 0) {
                w = this.default_width;
            }
        }

        return w;
    },

    get_height: function() {
        var h = $('#' + this.plot_id).css('height');
        h = parseFloat(h.substring(0, h.length-2));
        console.log('* ' + this.plot_id + ' height: ' + h);

        if (h < 200) {
            var width = this.get_width();
            return width * 0.6;
        } else {
            return h;
        }

    },

};
// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_crrw_usmap.plot_id] = fig_crrw_usmap;
}
var fig_crrw_stmap = {
    plot_id: 'fig_crrw_stmap',
    data_file: 'US-latest.json',
    vpp: null,
    vpp_id: '#fig_crrw_stmap_vpp',

    colorscale: {
        cdts: {
            name: 'Case Doubling Time',
            min: 0,
            mid: 50,
            max: 100,
            schema: [
                [0, 'rgba(255, 0, 0, 1)'],
                [0.5, 'rgba(255, 255, 0, 1)'],
                [1, 'rgba(144, 238, 144, 1)']
            ]
        },
        crcs: {
            name: 'CrRW Status',
            min: 0,
            mid: 1,
            max: 2,
            schema: [
                [0, 'green'],
                [0.5, 'gold'],
                [1, 'red']
            ]
        },
        tcps: {
            name: 'Total Cases / Population',
            min: 0,
            mid: 0.03,
            max: 0.06,
            schema: [
                [0,   'rgba(254, 240, 206, 1)'],
                [0.5, 'rgba(253, 164, 93, 1)'],
                [1, 'rgba(255, 30, 2, 1)']
            ]
        },
        pvis: {
            name: 'Pandemic Vulnerability Index',
            min: 0.3,
            mid: 0.5,
            max: 0.7,
            schema: [
                [0,   'rgba(253, 231, 228, 1)'],
                [0.5, 'rgba(240, 90, 158, 1)'],
                [1, 'rgba(71, 1, 103, 1)']
            ]
        }
    },
    
    fmt_comma: d3.format(","),
    geojson_url_base: "./static/data/map/",

    get_geojson_url: function(state) {
        if (state == 'US') {
            // return this.geojson_url_base + "us-states.json?ver=" + Math.random();
            return this.geojson_url_base + "us-states.json";
        } else {
            // return this.geojson_url_base + "us-"+state+".json?ver=" + Math.random();
            return this.geojson_url_base + "us-"+state+".json";
        }
    },

    center_zoom: {
        AL: [32.83094098386724, -86.72798630623657, 5.555648752272612, 6.505648752272609],
        AK: [63.44693850362876, -152.35437607298434, 2.7821258120506602, 3.582125812050661],
        AZ: [34.22032129272864, -111.79519254393165, 5.151412188068152, 6.151412188068149],
        AR: [34.74154293076825, -92.27158518339274, 5.3909149325614415, 6.890914932561438],
        CA: [37.45075663829661, -119.15385736551389, 4.203726247727388, 5.503726247727385],
        CO: [39.031159219718006, -105.50860962020852, 4.851412188068152, 6.551412188068148],
        CT: [41.55715657621522, -72.7299787240895, 6.636700474857865, 8.299999999999999],
        DE: [39.15099498387974, -75.36087912973886, 7.063404857504172, 7.96340485750417],
        DC: [38.896758078722826, -77.02494504184142, 9.863382259558914, 10.699999999999996],
        FL: [27.887125200731163, -83.79563908145951, 4.788425024767943, 6.08842502476794],
        GA: [32.80136845685382, -83.17089284876477, 5.194073777040557, 6.494073777040554],
        HI: [20.60743963352357, -157.54104533361146, 5.280893574706169, 6.6808935747061655],
        ID: [45.61980167243152, -114.16598280970521, 4.736549065241494, 5.636549065241491],
        IL: [39.81074645701159, -88.99580463570834, 5.24346021698839, 6.1434602169883865],
        IN: [39.799696826456255, -86.22002516386937, 5.397696781192849, 6.5976967811928455],
        IA: [42.10491391119382, -93.41377777792462, 5.211168201429747, 6.8111682014297426],
        KS: [38.440684985214176, -98.28074220678246, 4.808343825293441, 6.408343825293437],
        KY: [37.564568416051415, -85.6694500400194, 5.259756013361598, 6.559756013361594],
        LA: [30.99086613113124, -91.43518683060825, 5.380138585345384, 6.6801385853453805],
        ME: [45.289657532234486, -68.9674969445648, 5.229988796751516, 6.329988796751513],
        MD: [38.81535418520116, -77.12180346403989, 6.003973887409244, 7.203973887409241],
        MA: [42.08303690793116, -71.71280982798328, 6.0390902791042025, 7.439090279104199],
        MI: [44.5801516216078, -86.36481608559717, 4.799287957423174, 5.899287957423171],
        MN: [46.38085826405498, -93.6717735092464, 4.8000000000000005, 5.799999999999998],
        MS: [32.67036218623886, -89.64788757469944, 5.536594679723923, 6.43659467972392],
        MO: [38.38745607075799, -92.45400615072117, 5.202740687503251, 6.302740687503248],
        MT: [46.69748337383348, -109.89449604217452, 4.194267559094335, 5.694267559094331],
        NE: [41.35954643228564, -99.749047264115, 4.882358115519469, 6.182358115519465],
        NV: [38.61884501147105, -116.78201005530627, 4.896457889700124, 5.696457889700121],
        NH: [44.01014312907287, -71.52454991154269, 6.222515228018716, 7.0225152280187135],
        NJ: [40.14494695293476, -74.56351899912465, 6.266427775437659, 7.366427775437656],
        NM: [34.200386344213044, -106.07109251748108, 5.10199102508721, 6.101991025087207],
        NY: [42.93475020043314, -75.85682602572393, 4.851412188068152, 6.151412188068149],
        NC: [35.212586257912264, -79.89760235349581, 4.878911947457379, 6.178911947457375],
        ND: [47.45124418753352, -100.37322141588692, 4.833557666103269, 6.333557666103265],
        OH: [40.244096346922646, -82.58889854466332, 5.37060940340765, 6.657060940340762],
        OK: [35.36240917258573, -98.67768864171694, 4.4393485316272955, 6.239348531627291],
        OR: [44.14153619035105, -120.49700768838579, 4.640168187669632, 6.240168187669628],
        PA: [40.93561623669444, -77.63858939515887, 5.003288622967021, 6.9032886229670165],
        RI: [41.644399559477705, -71.49968794595952, 8.093127369668101, 8.993127369668098],
        SC: [33.57961112709421, -80.89443809845852, 5.878145529643364, 6.97814552964336],
        SD: [44.21476029518314, -100.23875902228633, 5.184352210170486, 6.384352210170482],
        TN: [35.83840909453255, -85.97782123718252, 5.064853245762301, 6.464853245762296],
        TX: [31.38153766444762, -100.08651780956296, 4.440010149181202, 5.340010149181198],
        UT: [39.57383395300832, -111.44344606283937, 5.402824376136306, 6.202824376136303],
        VT: [43.88191442670171, -72.52570703386135, 6.430489799445501, 7.330489799445497],
        VA: [37.48779928349346, -79.42283700816557, 5.092093635377879, 6.492093635377874],
        WA: [47.39956277899745, -120.79115434451177, 5.500000000000008, 6.300000000000005],
        WV: [38.9752685512272, -80.17909479124876, 5.880624334739462, 6.780624334739459],
        WI: [44.75598451280965, -89.84999463098484, 5.402824376136305, 6.302824376136302],
        WY: [43.00465749846177, -107.54231152504644, 5.001412188068152, 6.251412188068149],

        // for the USA map
        US: [41.341570863844055, -112.28385033630519, 1.33, 3.0333333333333408],

        // for the territories
        "AS": [-14.287319715841264, -170.6875293445853, 8.900000000000004, 9.900000000000004],
        "GU": [13.4352408224931, 144.79330364803013, 8.999999999999982, 9.999999999999982],
        "MP": [15.101249677795451, 145.7078289288088, 8.799999999999983, 9.799999999999983],
        "PR": [18.19379353240403, -66.41591225952243, 6.69999999999989, 7.89999999999999],
        "VI": [18.03447726727822, -64.79825504504345, 8.099999999999985, 9.099999999999985]
    },

    current: {
        date: null,
        state: null,
        attr: 'crcs'
    },

    plot_config: {
        responsive: true,
        // displayModeBar: false,
        scrollZoom: true,
    },

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                attr_colorscales: this.colorscale,
                current: this.current,
                date: null,
                dates: [],
                county: {
                    fips: null,
                    data: {}
                }
            },
            methods: {
                get_attr_colorscale_legend: function(attr_colorscale) {
                    var style = "background: linear-gradient(90deg";
                    for (var i = 0; i < attr_colorscale.schema.length; i++) {
                        var schema_item = attr_colorscale.schema[i];
                        style += ', ' + schema_item[1] + ' ' + (schema_item[0] * 100) + '%'
                    } 
                    style += ');'
                    return style;
                },

                update_color: function(attr) {
                    this.current.attr = attr;
                    fig_crrw_stmap.update(fig_crrw_stmap.data);
                },

                get_detail: function() {
                    var date_idx = this.dates.indexOf(this.date);
                    return {
                        FIPS: this.county.data.FIPS,
                        name: this.county.data.name,
                        state: this.county.data,
                        pop: this.county.data.pop,
                        cdt: this.county.data.cdts[date_idx],
                        crp: this.county.data.crps[date_idx],
                        crt: this.county.data.crts[date_idx],
                        ncc: this.county.data.nccs[date_idx],
                        dnc: this.county.data.dncs[date_idx],
                        dth: this.county.data.dths[date_idx],
                        dtr: this.county.data.dtrs[date_idx],
                        crc: this.county.data.crcs[date_idx],
                        pvi: this.county.data.pvis[date_idx],
                        tcp: this.county.data.nccs[date_idx] / this.county.data.pop
                    }
                },

                get_detail_by_date: function(date) {
                    this.date = date;
                    return this.get_detail();
                },

                fmt_comma: function(v) {
                    return fig_crrw_stmap.fmt_comma(v);
                }
            }
        });
    },

    update: function(data) {
        this.data = data;
        this.current.state = data.state;
        this.current.date = data.date;
    
        // update the vpp
        this.vpp.date = data.date;
        this.vpp.dates = data.dates;

        // create the data on this date
        this._create_plot_data();

        // update the layout
        this._create_plot_layout();

        Plotly.purge(this.plot_id);
        Plotly.newPlot(
            this.plot_id,
            this.plot_data,
            this.plot_layout,
            this.plot_config
        );
        
        // re-bind click event
        this._bind_click_event();

        // re-bind hover event
        this._bind_hover_event();

        // update the last update
        $('#' + this.plot_id + '_last_update').html(data.date);
        $('#' + this.plot_id + '_state_name').html(data.state);
    },

    update_by_date: function(date) {
        this.current.date = date;

        // update hte vpp
        this.vpp.date = date;
        
        // create the layout
        // this._create_plot_layout();
        
        // create the data on this date
        var mydata = this._create_mydata();
        var update_plot_data = [{
            locations: this.unpack(mydata, 'fips'),
            text: this.unpack(mydata, 'txt'),
            z: this.unpack(mydata, 'val'),
        }];
        
        // update the figure
        Plotly.animate(
            this.plot_id,
            {
                data: update_plot_data,
                traces: [0],
                layout: {},
            },
            {
                transition: {
                    duration: 100,
                    easing: "cubic-in-out",
                },
                frame: {
                    duration: 100,
                },
            }
        );

        // update hte last update time
        $('#' + this.plot_id + '_last_update').html(this.current.date);
    },

    _bind_click_event: function() {
        // bind click events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_click', function(data) {
            var county_fips = data.points[0].location;
            fig_crrw_stmap.show_detail(county_fips)
            jarvis.show_county(county_fips);
        });
    },

    _bind_hover_event: function() {
        // bind hover events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_hover', function(data) {
            var county_fips = data.points[0].location;
            // jarvis.show_county(state);
            // fig_crrw_stmap.show_detail(county_fips)
        });
    },

    show_detail: function(county_fips) {
        // console.log('* show detail: ' + county_fips);
        this.vpp.county.fips = county_fips;
        this.vpp.county.data = this.data.county_data[county_fips];
        // this.vpp.$forceUpdate();
    },

    _create_mydata: function() {
        var date = this.current.date;
        var date_idx = this.data.dates.indexOf(date);
        var rows = this.data.county_data;
        var mydata = [];

        for (var fips in rows) {
            if (rows.hasOwnProperty(fips)) {
                var obj = rows[fips];
                var cdt = obj.cdts[date_idx];
                var crp = obj.crps[date_idx];
                var crt = obj.crts[date_idx];
                var ncc = obj.nccs[date_idx];
                var dnc = obj.dncs[date_idx];
                var dth = obj.dths[date_idx];
                var dtr = obj.dtrs[date_idx];
                var pvi = obj.pvis[date_idx];
                var crc = obj.crcs[date_idx];
                var crc_v = {R:2, Y:1, G:0}[crc];
                var tcp = ncc / obj.pop;

                // decide show which value as default
                var val = null;
                if (this.current.attr == 'crcs') {
                    val = crc_v;
                } else if (this.current.attr == 'tcps') {
                    val = tcp;
                } else {
                    val = obj[this.current.attr][obj[this.current.attr].length - 1];
                }
                var r = {
                    fips: fips,
                    val: val,
                    txt: obj.name + ', ' + obj.state + '<br>' +
                        // ' (' + fips + ', Population: '+this.fmt_comma(obj.pop)+')<br>'+
                        // 'For ' + date + ' <br>' +
                        // 'Cr7d100k: <b>' + crp.toFixed(1) + ' cases per 100k </b><br>' +
                        // 'RW_Cr7d100k: <b>' + crt.toFixed(2) + ' </b><br>' +
                        // 'CDT: <b>' + cdt.toFixed(1) + ' days </b><br>' +
                        'New Cases: <b>' + this.fmt_comma(dnc) + ' </b><br>' + 
                        'Total Cases: <b>' + this.fmt_comma(ncc) + ' </b><br>' + 
                        // 'Total Cases/Population: <b>' + (tcp*100).toFixed(4) + '% </b><br>' + 
                        // 'Total Death: <b>' + this.fmt_comma(dth) + ' </b><br>' + 
                        // 'Death Rate: <b>' + (dtr*100).toFixed(2) + '%</b><br>' +
                        ''
                };
                mydata.push(r);
            }
        }

        return mydata;
    },
    
    _create_plot_data: function() {
        // create the data list
        var mydata = this._create_mydata();

        // generate the plot_data for plotly
        this.plot_data = [];

        this.plot_data.push({
            name: '',
            type: 'choropleth',
            locationmode: 'USA-states',
            locations: this.unpack(mydata, 'fips'),

            locationmode: "geojson-id",
            geojson: this.get_geojson_url(this.current.state),

            text: this.unpack(mydata, 'txt'),
            z: this.unpack(mydata, 'val'),

            hovertemplate: '%{text}',

            zmin: this.colorscale[this.current.attr].min,
            zmax: this.colorscale[this.current.attr].max,

            colorscale: this.colorscale[this.current.attr].schema,

            hoverlabel: {
                bgcolor: '#000000',
                font: {
                    size: 12,
                    color: '#ffffff'
                },
                align: 'left'
            },

            showlegend: false,
            showscale: false,

            marker: {
                line: {
                    color: "#333333",
                    width: 1,
                },
            },
        });

    },

    _create_plot_layout: function() {
        var state_loc = this.center_zoom[this.current.state];
        var lat = state_loc[0];
        var lon = state_loc[1];
        var zoom = state_loc[3];

        this.plot_layout = {
            margin: { t: 0 , b: 0, l: 0, r: 0},
            geo: {
                scope: 'world',
                projection: {
                    type: 'mercator'
                },
                center: {
                    lat: lat,
                    lon: lon,
                },
                fitbounds: 'locations',
                zoom: zoom,
                showframe: false,
                showlakes: false
            }
        };
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    },


    get_width: function() {
        var w = $('#' + this.plot_id).css('width');
        w = parseFloat(w.substring(0, w.length-2));
        console.log('* ' + this.plot_id + ' width: ' + w);
        
        var widths = [];
        if (w < 100) {
            // ask help !!!
            // 40 is the padding of the container
            w = jarvis.guess_width(this.plot_id) - 40;
            if (w == 0) {
                w = this.default_width;
            }
        }

        return w;
    },

    get_height: function() {
        var h = $('#' + this.plot_id).css('height');
        h = parseFloat(h.substring(0, h.length-2));
        console.log('* ' + this.plot_id + ' height: ' + h);

        if (h < 200) {
            var width = this.get_width();
            return width * 0.6;
        } else {
            return h;
        }

    },

};
// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_crrw_stmap.plot_id] = fig_crrw_stmap;
}

var figmker_crrw_trend = {
    version: '1.2.0',

    make_fig: function(plot_id, data, state, fips) {
        if ($('#' + plot_id).length>0) {
            // have already there
            // $( "#" + plot_id ).effect( 'pulsate', {}, 200, null );
            // move to the first
            var parent_id = $( "#" + plot_id ).parent().attr('id');
            $( "#" + plot_id ).prependTo('#'+parent_id);
            return;
        }
        var fig = {
            plot_id: plot_id,
            color_range: [
                'green',
                'gold',
                'red'
            ],
            state: state,
            fips: fips,
            data: data,
            crp_threshold_1: 15,
            crp_threshold_2: 30,
            crp_threshold_3: 10
        };
        var is_cnty = false;
        var datatmp = null;
        if (typeof(fips)=='undefined') {
            is_cnty = false;
            datatmp = data.state_data[state];
        } else if (fips == 'mchrr') {
            is_cnty = false;
            datatmp = data.mc_data[state];
        } else if (fips == 'world') {
            // the state is country code
            is_cnty = false;
            datatmp = data.world_data[state];
        } else {
            is_cnty = true;
            if (data.data.hasOwnProperty(fips)) {
                datatmp = data.data[fips];
            }
        }
        if (datatmp == null) {
            return null;
        }
        fig.is_cnty = is_cnty;
        
        // create the DOM obj for this figure
        var cal_lbl = is_cnty? 
            datatmp.name + ', ' + datatmp.state : 
            datatmp.name;
        $('#fig_crrw_trends').prepend(
            '<div id="'+fig.plot_id+'" class="fig-crrw-trend d-flex justify-content-start align-items-start align-items-stretch">'+
            '<div class="crrw-trend-info">'+
            '<div class="crrw-trend-bar"><a href="javascript:void(0);" title="Remove this chart" onclick="jarvis.remove_trend(\''+fig.plot_id+'\')"><i class="fa fa-times"></i></a></div>'+
            '<div class="crrw-trend-label">'+cal_lbl+'</div>'+
            '</div>'+
            '<div id="'+fig.plot_id+'_chart" class="crrw-trend-chart"></div>' + 
            '</div>'
        );

        fig.cal_data = [];
        var base_zero = 50;
        fig.data_crps = datatmp.crps.map(function(v, i) {
            return v / 2 + base_zero;
        });
        fig.data_crts = datatmp.crts.map(function(v, i) {
            if (v>5) v = 5;
            return -v * 10 + base_zero;
        });
        // get the area fill of CrRW status
        fig.data_crrw_y = datatmp.crcs.map(function(v, i) {
            if (v == 'Y') {
                return fig.data_crps[i] - fig.data_crts[i];
            } else {
                return null;
            }
        });
        fig.data_crrw_r = datatmp.crcs.map(function(v, i) {
            if (v == 'R') {
                return fig.data_crps[i] - fig.data_crts[i];
            } else {
                return null;
            }
        });
        fig.data_crrw_g = datatmp.crcs.map(function(v, i) {
            if (v == 'G') {
                return fig.data_crps[i] - fig.data_crts[i];
            } else {
                return null;
            }
        });
        // get the CrRW status bars
        fig.data_crrw_bar = datatmp.crcs.map(function(v, i) {
            var c = {G:'green', Y:'gold', R:'red'}[v];
            var v2 = {G:0, Y:1, R:2}[v];
            return { value: v, itemStyle: {color: c} };
        });
        
        // put the calendar
        fig.option = {
            legend: {
                data: [
                    'Cr7d100k',
                    'RW_Cr7d100k'
                ],
                top: 10,
                left: 50,
                backgroundColor: 'rgba(255,255,255,.5)'
            },
            axisPointer: {
                type: 'line',
                link: {xAxisIndex: 'all'}
            },
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    // console.log(params);
                    // if params
                    var tip = [params[0].axisValue + '<br>'];
                    for (var i = 0; i < 3; i++) {
                        var param = params[i];
                        var val = param.value;
                        if (i==0) {
                            // this is the Cr7d100k
                            val = ((val - 50) * 2).toFixed(2);
                        } else if (i==1) {
                            // this is the RW_Cr7d100k
                            val = (- (val - 50) / 10).toFixed(2);
                        } else {
                            // this is the CrRW status
                            val = '<span class="crrw-day-badge crrw-day-'+val+'">'+val+'</span>';
                        }
                        tip.push(param.marker + ' ' + param.seriesName + ': ' + val + '<br>');
                    }
                    return tip.join('');
                }
            },
            xAxis: {
                type: 'category',
                data: data.dates,
                axisLabel: {
                    formatter: function (value, idx) {
                        var date = new Date(value);
                        return [date.getMonth() + 1, date.getDate()].join('-');
                    }
                },
                splitLine: {
                    show: true
                }
            },
            yAxis: {
                type: 'value',
                min: 20,
                max: 110,
                interval: 10,
                axisLabel: {
                    formatter: function (value, idx) {
                        if (value <= 50) {
                            // this is RW_Cr7d100k
                            return (5 - Math.abs(value / 10)).toFixed(0);
                        } else {
                            // this is Cr7d100k
                            return ((value - 50) * 2).toFixed(0);
                        }
                    }
                },
            },
            grid: {
                top: 10,
                right: 5,
                bottom: 20,
                left: 40
            },
            graphic: [
            {
                type: 'group',
                left: '45',
                top: '55',
                children: [{
                    type: 'rect',
                    z: 90,
                    left: 'left',
                    top: 'middle',
                    shape: {
                        width: 80,
                        height: 14
                    },
                    style: {
                        fill: '#fff',
                        lineWidth: 0
                    }
                }, {
                    type: 'text',
                    z: 100,
                    left: 'left',
                    top: 'middle',
                    style: {
                        fill: 'rgba(255, 141, 4, 0.5)',
                        text: 'Cr7d100k=30',
                        font: '11px'
                    }
                }]
            }, 
            // {
            //     type: 'group',
            //     left: '45',
            //     top: '55',
            //     children: [{
            //         type: 'rect',
            //         z: 90,
            //         left: 'left',
            //         top: 'middle',
            //         shape: {
            //             width: 80,
            //             height: 14
            //         },
            //         style: {
            //             fill: '#fff',
            //             lineWidth: 0
            //         }
            //     }, {
            //         type: 'text',
            //         z: 100,
            //         left: 'left',
            //         top: 'middle',
            //         style: {
            //             fill: 'rgba(255, 141, 4, 0.5)',
            //             text: 'Cr7d100k=15',
            //             font: '11px'
            //         }
            //     }]
            // }, 
            {
                type: 'group',
                left: '45',
                top: '78',
                children: [{
                    type: 'rect',
                    z: 90,
                    left: 'left',
                    top: 'middle',
                    shape: {
                        width: 80,
                        height: 10
                    },
                    style: {
                        fill: '#fff',
                        lineWidth: 0
                    }
                }, {
                    type: 'text',
                    z: 100,
                    left: 'left',
                    top: 'middle',
                    style: {
                        fill: 'rgba(255, 141, 4, 0.5)',
                        text: 'Cr7d100k=10',
                        font: '9px'
                    }
                }]
            }, {
                type: 'group',
                left: '45',
                top: '105',
                children: [{
                    type: 'rect',
                    z: 90,
                    left: 'left',
                    top: 'middle',
                    shape: {
                        width: 80,
                        height: 14
                    },
                    style: {
                        fill: '#fff',
                        lineWidth: 0
                    }
                }, {
                    type: 'text',
                    z: 100,
                    left: 'left',
                    top: 'middle',
                    style: {
                        fill: 'rgba(255, 0, 0, 0.5)',
                        text: 'RW_Cr7d100k=1',
                        font: '11px'
                    }
                }]
            }],
            series: [
            {
                type: 'line',
                name: 'Cr7d100k',
                data: fig.data_crps,
                symbolSize: 1,
                itemStyle: {
                    color: 'blue'
                },
                lineStyle: {
                    color: 'blue'
                },
                markLine: {
                    symbol: 'none',
                    lineStyle: {
                        color: 'orange'
                    },
                    data: [
                    // { 
                    //     // 15
                    //     name: 'Cr7d100k=' + fig.crp_threshold_1, 
                    //     yAxis: base_zero + fig.crp_threshold_1 / 2
                    // }, 
                    { 
                        // 30
                        name: 'Cr7d100k=' + fig.crp_threshold_2, 
                        yAxis: base_zero + fig.crp_threshold_2 / 2
                    },
                    { 
                        // 10
                        name: 'Cr7d100k=' + fig.crp_threshold_3, 
                        yAxis: base_zero + fig.crp_threshold_3 / 2
                    }]
                }
            },
            {
                type: 'line',
                name: 'RW_Cr7d100k',
                data: fig.data_crts,
                symbolSize: 1,
                itemStyle: {
                    color: 'purple'
                },
                lineStyle: {
                    color: 'purple'
                },
                markLine: {
                    symbol: 'none',
                    lineStyle: {
                        color: 'red'
                    },
                    data: [{ 
                        name: 'RW_Cr7d100k=1', 
                        yAxis: base_zero - 10,
                        // label: {
                        //     formatter: '{b}',
                        //     position: 'insideStartBottom'
                        // }
                    }]
                },
                stack: 'crrw'
            },
            {
                type: 'bar',
                name: 'CrRW Status',
                show: false,
                data: fig.data_crrw_bar,
            },
            // for the area
            {
                type: 'line',
                data: fig.data_crrw_r,
                symbolSize: 0,
                areaStyle: {
                    color: 'red'
                },
                lineStyle: {
                    width: 0
                },
                stack: 'crrw'
            },
            {
                type: 'line',
                data: fig.data_crrw_y,
                symbolSize: 0,
                areaStyle: {
                    color: 'gold'
                },
                lineStyle: {
                    width: 0
                },
                stack: 'crrw'
            },
            {
                type: 'line',
                data: fig.data_crrw_g,
                symbolSize: 0,
                areaStyle: {
                    color: 'green'
                },
                lineStyle: {
                    width: 0
                },
                stack: 'crrw'
            }
            ]
        };
        fig.chart = echarts.init(document.getElementById(fig.plot_id + '_chart'));
        fig.chart.setOption(fig.option);

        // bind click event
        fig.chart.on('click', function(params) {
            // console.log(params);
            if (params.componentType == "markLine") {
                return;
            }
            var date_Ymd = params.name;
            console.log('* clicked ' + date_Ymd);
            // var date_mdy = d3.timeFormat('%-m/%-d/%y')(d3.timeParse('%Y-%m-%d')(date_Ymd));
        
            // update the maps by date
            if (jarvis.hasOwnProperty('update_maps_by_date')) {
                jarvis.update_maps_by_date(date_Ymd);
            }
        });

        fig.chart.group = 'trends';
        echarts.connect('trends');

        return fig;
    }
}
var figmker_crrw_calendar = {
    dom_id: '#fig_crrw_calendars',

    clear_and_make_fig: function(plot_id, data, country, state, fips, is_display_label) {
        $(this.dom_id).html('');
        $(this.dom_id + '_region').html(country);
        return this.make_fig(plot_id, data, country, state, fips, is_display_label);
    },

    make_fig: function(plot_id, data, country, state, fips, is_display_label) {
        if ($('#' + plot_id).length>0) {
            // have already there
            $( "#" + plot_id ).effect( 'pulsate', {}, 200, null );
            return;
        }
        
        if (typeof(is_display_label) == 'undefined') {
            is_display_label = true;
        }

        var lv = null;
        var cal_lbl = null;
        var data_idx = null;
        var _data = null;

        if (country != null) {
            lv = 'country';
            cal_lbl = country;
            data_idx = country;
            _data = data.world_data;
        } else if (fips != null) {
            lv = 'county'
            cal_lbl = fips;
            data_idx = fips;
            _data = data.county_data;
        } else {
            lv = 'state';
            cal_lbl = state;
            data_idx = state;
            _data = data.state_data;
        }
        
        var html = [
            '<div id="'+plot_id+'" class="fig-crrw-calendar d-flex justify-content-start align-items-start">', 
            is_display_label?'<div class="crrw-day-label">'+cal_lbl+'</div>' : '', 
            '<div id="'+plot_id+'_chart" class="crrw-day-chart"></div>',
            '</div>'
        ].join('');

        $(this.dom_id).append(html);

        var fig = {
            plot_id: plot_id,
            color_range: [
                'green',
                'gold',
                'red'
            ],
            country: country,
            state: state,
            fips: fips,
            data: data,
            date_idx: data.dates.length - 1
        };

        fig.cal_data = _data[data_idx].crcs.map(function(v, i) {
            return [ data.dates[i], {R:2, Y:1, G:0}[v]];
        });

        fig.scatter_data = [{
            value: fig.cal_data[fig.cal_data.length - 1],
            visualMap: false
        }];
        
        // put the calendar
        fig.option = {
            tooltip: {
                formatter: function(params) {
                    // console.log(params);
                    // if params
                    var val = params.value[1];
                    return params.value[0] + "<br>" +
                        'CrRW Status: ' + '<span class="crrw-day-badge crrw-day-'+val+'">'+{2:"R", 1:'Y', 0:'G'}[val]+'</span>';
                }
            },
            visualMap: {
                min: 0,
                max: 2,
                // right: 0,
                // top: 0,
                // itemHeight: 80,
                // text: [this.num_max + ' days', '0'],
                inRange: {
                    color: fig.color_range
                },
                show: false
            },
            calendar: {
                top: 18,
                left: 50,
                cellSize: 10,
                range: ['2020-01-01', '2021-01-31'],
                monthLabel: {
                    show: true,
                    fontSize: 10,
                    formatter: function(param) {
                        if (param.M == 1) {
                            return param.yyyy + ' ' + param.nameMap;
                        } else {
                            return param.nameMap;
                        }
                    }
                },
                yearLabel: {
                    fontSize: 12
                },
                itemStyle: {
                    borderWidth: 1
                }
            },
            series: [{
                type: 'heatmap',
                name: fig.plot_id + '-' + 'cal',
                coordinateSystem: 'calendar',
                data: fig.cal_data
            }, 
            {
                type: 'scatter',
                name: fig.plot_id + '-' + 'dot',
                coordinateSystem: 'calendar',
                data: fig.scatter_data,
                symbolSize: 9,
                itemStyle: {
                    color: 'black'
                }
            }]
        };
        fig.chart = echarts.init(document.getElementById(fig.plot_id + '_chart'));
        fig.chart.setOption(fig.option);

        fig.update_by_date = function(date) {
            this.date_idx = this.data.dates.indexOf(date);

            // udpate the scatter
            this.scatter_data = [{
                value: this.cal_data[this.date_idx],
                visualMap: false
            }];
            
            // update the echart
            this.option.series[1].data = this.scatter_data;
            this.chart.setOption(this.option, true);
        },

        // bind click event
        fig.chart.on('click', function(params) {
            console.log(params);

            // get the figure obj
            var fig_plot_id = params.seriesName.split('-')[0];
            var fig_obj = window[fig_plot_id];

            // get date
            var date_Ymd = params.value[0];
            // var date_mdy = d3.timeFormat('%-m/%-d/%y')(d3.timeParse('%Y-%m-%d')(date_Ymd));
            console.log('* clicked ' + date_Ymd);

            // update the map
            if (jarvis.hasOwnProperty('update_by_date')) {
                jarvis.update_by_date(date_Ymd);
            }
        });

        return fig;
    }
}

var jarvis = {
    plots: {},
    us_data: {},
    state_data: {},
    world_data: {},
    base_data_url: './covid_data/',

    // for the auto play
    proc_play: null,
    date_idx: 0,
    frame_duration: 500,

    get_state_data_file_url: function (state) {
        return this.base_data_url + 'state/' + state + '-history.json';
    },

    init: function() {
        // init the toast
        $('.toast').toast({
            delay: 10000
        });

        // bind the fips to states
        for (var a in this.states) {
            var fips = this.states[a].fips;
            this.states[fips] = this.states[a];
        }

        // bind enter
        $('#input_fips').on('keypress', function(event) {
            if (event.which == 13) {
                jarvis.add_trend();
            }
        });

        // sortable
        $('#fig_crrw_trends').sortable({
            handle: '.crrw-trend-label',
            placeholder: "ui-state-highlight"
        });
        $('#fig_crrw_trends').disableSelection();

        // init the components
        fig_crrw_worldmap.init();
        fig_crrw_usmap.init();
        fig_crrw_stmap.init();

        $.get(
            this.base_data_url + 'world-fc-history.json',
            { ver: Math.random() },
            function(data) {
                jarvis.world_data = data;
                // update the date_idx
                jarvis.date_idx = data.dates.length - 1;

                // update the map
                fig_crrw_worldmap.update(data);

                // init the calendar by USA cases
                jarvis.init_calendar('USA');

                jarvis.ssmsg('Finished initialization.')
                setTimeout('jarvis.ssclose();', 500);
            }, 'json'
        );

        $.get(
            this.get_state_data_file_url('US'),
            { ver: Math.random() },
            function(data) {
                jarvis.us_data = data;
                fig_crrw_usmap.update(data);

                jarvis.show_state('MN');
                jarvis.ssmsg('Finished initialization.')
                setTimeout('jarvis.ssclose();', 500);
            }, 'json'
        );
    },

    init_calendar: function(country) {
        if (typeof(country) == 'undefined') {
            country = 'USA';
        }
        // then make a figure
        if (!window.hasOwnProperty('figmker_crrw_calendar')) {
            return;
        }
        window.fig_crrw_calendar = figmker_crrw_calendar.clear_and_make_fig(
            'fig_crrw_calendar',
            jarvis.world_data,
            country,
            null,
            null,
            false
        );
    },

    show_country: function(country) {
        this.show_country_trend(country);
    },

    show_country_trend: function(country) {
        console.log('* show country trend: ' + country);
        var plot_id = 'fig_crrw_trend_' + country;
        var fig = figmker_crrw_trend.make_fig(
            plot_id, 
            this.world_data, 
            country,
            'world'
        );
        if (fig == null) {
            return;
        } else {
            this.plots[plot_id] = fig;
        }

    },

    show_state: function(state) {
        console.log('* show state: ' + state);
        if (this.state_data.hasOwnProperty(state)) {
            fig_crrw_stmap.update(this.state_data[state]);
            this.show_state_map(state);
            this.show_state_trend(state);
            return;
        }
        // get data if not exists
        $.get(
            this.get_state_data_file_url(state),
            { ver: Math.random() },
            function(data) {
                jarvis.state_data[data.state] = data;
                jarvis.show_state(data.state);
            }, 'json'
        );

    },

    show_state_map: function(state) {
        console.log('* show state map: ' + state);
        fig_crrw_stmap.update(jarvis.state_data[state]);
    },

    show_state_trend: function(state) {
        console.log('* show state trend: ' + state);
        var plot_id = 'fig_crrw_trend_' + state;
        var fig = figmker_crrw_trend.make_fig(
            plot_id, 
            this.us_data, 
            state
        );
        if (fig == null) {
            return;
        } else {
            this.plots[plot_id] = fig;
        }
    },

    show_county: function(fips) {
        this.show_county_trend(fips);
    },

    show_county_trend: function(fips) {
        console.log('* show county trend: ' + fips);
        var state_fips = fips.substring(0, 2);
        var state_abbr = this.states[state_fips].abbr;

        if (this.state_data.hasOwnProperty(state_abbr)) {
            this._show_county_trend(state_abbr, fips);
        } else {
            this.show_state_map(state_abbr);
        }
    },

    _show_county_trend: function(state_abbr, fips) {
        var plot_id = '';
        var fig = null;

        // plot_id = 'fig_crrw_calendar_' + fips;
        // fig = figmker_crrw_calendar.make_fig(
        //     plot_id, this.state_data, this.state_data.state, fips);
        // this.plots[plot_id] = fig;

        // plot_id = 'fig_crrw_calendar_' + fips;
        // fig = figmker_crrw_1dcal.make_fig(
        //     plot_id, this.state_data, this.state_data.state, fips);
        // this.plots[plot_id] = fig;
        
        plot_id = 'fig_crrw_trend_' + fips;
        fig = figmker_crrw_trend.make_fig(
            plot_id, 
            this.state_data[state_abbr], 
            this.state_data[state_abbr].state, 
            fips);
        if (fig == null) {
            return;
        } else {
            this.plots[plot_id] = fig;
        }
    },

    add_trend: function() {
        var fips = $('#input_fips').val();
        fips = fips.trim();
        fips = fips.toUpperCase();
        if (fips.length < 2 || fips.length > 5) {
            jarvis.msg('The input must be state abbr or FIPS code.', 'gold');
            return;
        }
        if (this.states.hasOwnProperty(fips)) {
            // ok, I guess it's a state abbr
            var state = fips;
            this.show_state_map(state);
            this.show_state_trend(state);
        } else {
            if (fips.length == 4) {
                fips = '0' + fips;
            }
            $('#input_fips').val(fips);
            this.show_county_trend(fips);
        }
    },

    remove_trend: function(plot_id) {
        $('#' + plot_id).remove();
    },

    update_by_date: function(date) {
        console.log('* jarvis update by date ' + date);

        // update the index first
        this.date_idx = this.world_data.dates.indexOf(date);

        // then update the calendar
        if (window.hasOwnProperty('fig_crrw_calendar')) {
            window.fig_crrw_calendar.update_by_date(date);
        }

        // last, update the map
        this.update_maps_by_date(date);
    },

    update_maps_by_date: function(date) {
        fig_crrw_worldmap.update_by_date(date);
        fig_crrw_usmap.update_by_date(date);
        fig_crrw_stmap.update_by_date(date);
    },

    auto_play: function() {
        if (this.date_idx >= this.world_data.dates.length - 1) {
            this.date_idx = 0;
            this.stop();
        } else {
            this.date_idx += 1;
            var next_date = this.world_data.dates[this.date_idx];
            this.update_by_date(next_date);
        }
    },

    stop: function() {
        if (this.proc_play == null) {
    
        } else {
            clearInterval(this.proc_play);
            this.proc_play = null;
        }
    },

    play: function() {
        if (this.proc_play == null) {
            this.proc_play = setInterval('jarvis.auto_play();', this.frame_duration);
        } else {
    
        } 
    },

    reset_fig_crrw_trends: function() {
        $('#fig_crrw_trends').html('');
    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    },

    states: {
        AL: { fips: '01', abbr: 'AL', name: 'Alabama' }, 
        AK: { fips: '02', abbr: 'AK', name: 'Alaska' }, 
        AS: { fips: '60', abbr: 'AS', name: 'American Samoa' },
        AZ: { fips: '04', abbr: 'AZ', name: 'Arizona' }, 
        AR: { fips: '05', abbr: 'AR', name: 'Arkansas' }, 
        CA: { fips: '06', abbr: 'CA', name: 'California' }, 
        CO: { fips: '08', abbr: 'CO', name: 'Colorado' }, 
        CT: { fips: '09', abbr: 'CT', name: 'Connecticut' }, 
        DE: { fips: '08', abbr: 'DE', name: 'Delaware' }, 
        FL: { fips: '12', abbr: 'FL', name: 'Florida' }, 
        GA: { fips: '13', abbr: 'GA', name: 'Georgia' }, 
        GU: { fips: '66', abbr: 'GU', name: 'Guam' },
        HI: { fips: '15', abbr: 'HI', name: 'Hawaii' }, 
        ID: { fips: '16', abbr: 'ID', name: 'Idaho' }, 
        IL: { fips: '17', abbr: 'IL', name: 'Illinois' }, 
        IN: { fips: '18', abbr: 'IN', name: 'Indiana' }, 
        IA: { fips: '19', abbr: 'IA', name: 'Iowa' }, 
        KS: { fips: '20', abbr: 'KS', name: 'Kansas' }, 
        KY: { fips: '21', abbr: 'KY', name: 'Kentucky' }, 
        LA: { fips: '22', abbr: 'LA', name: 'Louisiana' }, 
        ME: { fips: '23', abbr: 'ME', name: 'Maine' }, 
        MD: { fips: '24', abbr: 'MD', name: 'Maryland' }, 
        MA: { fips: '25', abbr: 'MA', name: 'Massachusetts' }, 
        MI: { fips: '26', abbr: 'MI', name: 'Michigan' }, 
        MN: { fips: '27', abbr: 'MN', name: 'Minnesota' }, 
        MS: { fips: '28', abbr: 'MS', name: 'Mississippi' }, 
        MO: { fips: '29', abbr: 'MO', name: 'Missouri' }, 
        MT: { fips: '39', abbr: 'MT', name: 'Montana' }, 
        NE: { fips: '31', abbr: 'NE', name: 'Nebraska' }, 
        NV: { fips: '32', abbr: 'NV', name: 'Nevada' }, 
        NH: { fips: '33', abbr: 'NH', name: 'New Hampshire' }, 
        NJ: { fips: '34', abbr: 'NJ', name: 'New Jersey' }, 
        NM: { fips: '35', abbr: 'NM', name: 'New Mexico' }, 
        NY: { fips: '36', abbr: 'NY', name: 'New York' }, 
        NC: { fips: '37', abbr: 'NC', name: 'North Carolina' }, 
        ND: { fips: '38', abbr: 'ND', name: 'North Dakota' }, 
        MP: { fips: '69', abbr: 'MP', name: 'Northern Mariana Islands' }, 
        OH: { fips: '39', abbr: 'OH', name: 'Ohio' }, 
        OK: { fips: '40', abbr: 'OK', name: 'Oklahoma' }, 
        OR: { fips: '41', abbr: 'OR', name: 'Oregon' }, 
        PA: { fips: '42', abbr: 'PA', name: 'Pennsylvania' }, 
        PR: { fips: '72', abbr: 'PR', name: 'Puerto Rico' }, 
        RI: { fips: '44', abbr: 'RI', name: 'Rhode Island' }, 
        SC: { fips: '45', abbr: 'SC', name: 'South Carolina' }, 
        SD: { fips: '46', abbr: 'SD', name: 'South Dakota' }, 
        TN: { fips: '47', abbr: 'TN', name: 'Tennessee' }, 
        TX: { fips: '48', abbr: 'TX', name: 'Texas' }, 
        VI: { fips: '78', abbr: 'VI', name: 'U.S. Virgin Islands' },
        UT: { fips: '49', abbr: 'UT', name: 'Utah' }, 
        VT: { fips: '50', abbr: 'VT', name: 'Vermont' }, 
        VA: { fips: '51', abbr: 'VA', name: 'Virginia' }, 
        WA: { fips: '53', abbr: 'WA', name: 'Washington' }, 
        DC: { fips: '09', abbr: 'DC', name: 'Washington, D.C.' }, 
        WV: { fips: '54', abbr: 'WV', name: 'West Virginia' }, 
        WI: { fips: '55', abbr: 'WI', name: 'Wisconsin' }, 
        WY: { fips: '56', abbr: 'WY', name: 'Wyoming' }
    },

    msg: function(s, color) {
        if (typeof(color)=='undefined') {
            color = 'blue';
        }
        $('#toast_rect').attr('fill', color);
        $('#toast_body').html(s);
        $('#toast').toast('show')
    },

    modal: function(ti, ct) {
        $('#modal-title').html(ti);
        $('#modal-body').html(ct);
        $('#modal').modal('show');
    }
};

$(document).ready(function(){
    jarvis.init();
})
</script>
</body>
</html>