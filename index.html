<!doctype html>
<html lang="en">

<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="icon" href="./static/img/favicon.ico">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
<script src="https://kit.fontawesome.com/cb45cc91b0.js" crossorigin="anonymous"></script>

<style>
html, body {
    background-color: whitesmoke;
    overflow: hidden;
}

p {
    margin-bottom: .5rem;
}

.wrapper {
}

/* fix for bootstrap template */
.bg-dark {
    background-color: #3d6b9c !important;
}

.tab-content {
    border: 1px solid #dee2e6;
    border-bottom: 0;
    padding: 10px 3px;
    background: white;
}
.nav-link {
    padding: .2rem .8rem;
}
.nav-tabs {
    border-top: 1px solid #dee2e6;
    border-bottom: 0;
    margin-bottom: 10px;
}
.nav-tabs .nav-link {
    font-size: .85rem;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    border-bottom-left-radius: .25rem;
    border-bottom-right-radius: .25rem;
}
.nav-tabs .nav-item.show .nav-link,
.nav-tabs .nav-link.active {
    border-bottom: 3px solid #3d6b9c;
    border-top: 0;
    margin-top: -1px;
}
.tab-content {
    padding: 0;
}
.card {
    margin: 0 0 0.4rem 0;
}
.tab-pane .card {
    border: 0;
    margin: 0;
    padding: 0;
}
.card-body {
    padding: .5rem;
}

.card-title {
    font-size: 1rem;
    margin-bottom: .2rem;
}

.card-text {
    font-size: .75rem;
}
.nav-tabs a {
    color: #666666;
}
.btn-group-sm>.btn, .btn-sm {
    padding: .15rem .8rem;
}
/****************************************
* Styles for this page
****************************************/
.txt-lg {
    font-size: 2rem !important;
    line-height: 1.9rem;
}
.txt-md {
    font-size: 1.5rem !important;
    line-height: 1.45rem;
}
.txt-sm {
    font-size: 1rem !important;
    line-height: 0.95rem;
}
.txt-mn {
    font-size: .75rem !important;
    line-height: .71rem;
}
.txt-xm {
    font-size: .55rem !important;
    line-height: .5rem;
}
.txt-red {
    color: red;
}
.txt-green {
    color: green;
}
.txt-blue {
    color: blue;
}
.txt-orange {
    color: orange;
}
.txt-num-label {
    margin-right: .5rem; 
    text-align: center;
}
/****************************************
* Styles for the us county map!!!
****************************************/
.counties {
  fill: none;
}
.county {
    stroke: #FFFFFF;
    stroke-width: 1px;
    opacity: .7;
}
.county:hover {
    z-index: 999;
    opacity: 1;
}
.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}
.d3-tip {
    line-height: 1;
    padding: 6px;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    border-radius: 4px;
    font-size: 12px;
}

/* a start screen for IE and hiding init */
#start-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}
.wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
}
@media screen and (max-width: 1600px){
    .txt-lg {
        font-size: 1.8rem !important;
        line-height: 1.7rem;
    }
    .txt-md {
        font-size: 1.1rem !important;
        line-height: 1.05rem;
    }
    .txt-sm {
        font-size: 0.9rem !important;
        line-height: 0.9rem;
    }
    .txt-mn {
        font-size: .7rem !important;
        line-height: .68rem;
    }
    .txt-xm {
        font-size: .5rem !important;
        line-height: .5rem;
    }
    .btn-group-sm>.btn {
        padding: .1rem .15rem;
        font-size: .8rem;
    }
    .card-title {
        font-size: .875rem;
    }
}

@media screen and (min-width: 1200px) and (max-width: 1400px){
    .txt-lg {
        font-size: 1.4rem !important;
        line-height: 1.3rem;
    }
    .txt-md {
        font-size: 0.9rem !important;
        line-height: 1.05rem;
    }
    .txt-sm {
        font-size: 0.8rem !important;
        line-height: 0.9rem;
    }
    .txt-mn {
        font-size: .65rem !important;
        line-height: .68rem;
    }
    .txt-xm {
        font-size: .5rem !important;
        line-height: .5rem;
    }
    .btn-group-sm>.btn {
        padding: .1rem .15rem;
        font-size: .8rem;
    }
    .card-title {
        font-size: .85rem;
    }
}
</style>
<title>COVID-19 Tracking</title>
</head>

<body>
    
<div id="start-screen">
    <h1>
        <i class="fa fa-globe-americas"></i>
        COVID-19 Tracking
    </h1>
    <div id="ss-msg">Initializing plots ...</div>
</div>

<div class="container-fluid wrapper">

    <div class="row">
        <div class="col"  style="padding-left:8px; padding-right:8px;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-globe-americas"></i>
                        COVID-19 Tracking | 
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="./cdtmap_county.html" class="btn btn-light">
                                <i class="far fa-map"></i> Animated County-Level CDT Map
                            </a>
                        </div> |
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="./cdtmap_state.html" class="btn btn-light">
                                <i class="far fa-map"></i> Animated State-Level CDT Map
                            </a>
                        </div> |
                        <!-- <i class="far fa-map"></i> <a href="./cdtmap_state.html">Animated State-Level CDT Map</a> | -->
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span id="pnl_last_update" class="last_update">mm/dd HH:MM</span>
                        </span>
                    </h5>
                </div>
            </div><!-- /.card -->
        </div>
    </div>

    <div id="vue_rgpanels">

    <div class="row"
        v-for="region in regions">
        <div class="col-lg-6 col-xl-4" style="padding-left:8px; padding-right:8px;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-user"></i>
                        {{ region.name }} Case Doubling Time |  
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>
                    </h5>
                    <div v-bind:id="'fig_cdtmap_' + region.name" style="width: 100%; min-width: 200px; min-height: 220px;">

                    </div>
                </div>
            </div><!-- /.card -->

        </div><!-- /.col-lg-6 .col-xl-4 -->


        <div class="col-lg-6 col-xl-4" style="padding-left:8px; padding-right:8px;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        {{ region.name }} Cases Trend | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>
                    </h5>
                    <div v-bind:id="'fig_caseline_' + region.name" style="width: 100%; min-width: 200px; height: 220px;">

                    </div>
                </div>
            </div><!-- /.card -->
        </div><!-- /.col-lg-6 .col-xl-4 -->


        <div class="col-lg-6 col-xl-4" style="padding-left:8px; padding-right:8px;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        {{ region.name }} Mortality Trend | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>
                    </h5>
                    <div v-bind:id="'fig_deathline_' + region.name" style="width: 100%; min-width: 200px; height: 220px;">

                    </div>
                </div>
            </div><!-- /.card -->
        </div><!-- /.col-lg-6 .col-xl-4 -->

    </div><!-- /.row for region -->

    </div><!-- /#vue_rgpanels -->


    <div class="row">
        <div class="col-lg-8" style="padding-left:8px; padding-right:8px;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-hourglass-half"></i>
                        Case Doubling Time | U.S. Counties | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button id="btn-toggle-us-mayo" type="button" class="btn btn-light"
                                style="font-weight: bold;" onclick="fig_heatmap_uscntycdt.filter_by_cdt(0, 0)">
                                <i class="fa fa-globe-americas"></i> All Counties
                            </button>
                        </div>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button type="button" class="btn btn-light"
                                onclick="fig_heatmap_uscntycdt.filter_by_cdt(0, 3)">CDT&le;3</button>
                            <button type="button" class="btn btn-light"
                                onclick="fig_heatmap_uscntycdt.filter_by_cdt(0, 5)">CDT&le;5</button>
                            <button type="button" class="btn btn-light"
                                onclick="fig_heatmap_uscntycdt.filter_by_cdt(0, 7)">CDT&le;7</button>
                            <button type="button" class="btn btn-light"
                                onclick="fig_heatmap_uscntycdt.filter_by_cdt(0, 10)">CDT&le;10</button>
                            <button type="button" class="btn btn-light"
                                onclick="fig_heatmap_uscntycdt.filter_by_cdt(0, 14)">CDT&le;14</button>
                            <button type="button" class="btn btn-light"
                                onclick="fig_heatmap_uscntycdt.filter_by_cdt(14, 100)">CDT&gt;14</button>
                            
                        </div>
                    </h5>
                    <div id="fig_heatmap_uscntycdt" style="width: 100%; min-width: 470px; min-height: 300px; height: 600px;">

                    </div>
                </div>
            </div><!-- /.card -->
        </div>

        <div class="col-lg-4" style="padding-left:8px; padding-right:8px;">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        County Cases Trend | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button id="btn-toggle-us-mayo" type="button" class="btn btn-light"
                                onclick="fig_casedeathline_cntys.reset_series();fig_cdtline_cntys.reset_series();">
                                RESET
                            </button>
                        </div>
                    </h5>
                    <div id="fig_casedeathline_cntys" style="width: 100%; min-width: 200px; height: 312px;">

                    </div>
                </div>
            </div><!-- /.card -->


            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        County Case Doubling Time Trend | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button id="btn-toggle-us-mayo" type="button" class="btn btn-light"
                                onclick="fig_caseline_cntys.reset_series();fig_cdtline_cntys.reset_series();">
                                RESET
                            </button>
                        </div>
                    </h5>
                    <div id="fig_cdtline_cntys" style="width: 100%; min-width: 200px; height: 232px;">

                    </div>
                </div>
            </div><!-- /.card -->

        </div>
    </div><!-- /.row -->


    <div class="row">

        <div class="col-lg-8" style="padding-left:8px; padding-right:8px;">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-hourglass-half"></i>
                        Case Doubling Time | States | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>
                    </h5>
                    <div id="fig_heatmap_usstatecdt" style="width: 100%; min-width: 470px; min-height: 300px; height: 500px;">
                    </div>
                </div>
            </div><!-- /.card -->

        </div>

        <div class="col-lg-4" style="padding-left:8px; padding-right:8px;">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        State Cases Trend | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button id="btn-toggle-us-mayo" type="button" class="btn btn-light"
                                onclick="fig_caseline_states.reset_series();fig_testline_states.reset_series();">
                                RESET
                            </button>
                        </div>
                    </h5>
                    <div id="fig_caseline_states" style="width: 100%; min-width: 200px; height: 220px;">

                    </div>
                </div>
            </div><!-- /.card -->


            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        State Test Positive Rate Trend | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button id="btn-toggle-us-mayo" type="button" class="btn btn-light"
                                onclick="fig_caseline_states.reset_series();fig_testline_states.reset_series();">
                                RESET
                            </button>
                        </div>
                    </h5>
                    <div id="fig_testline_states" style="width: 100%; min-width: 200px; height: 220px;">

                    </div>
                </div>
            </div><!-- /.card -->

        </div>

    </div><!-- /.row -->


    <div class="row">

        <div class="col-8" style="padding-left:8px; padding-right:8px;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-hourglass-half"></i>
                        Case Doubling Time | Worldwide | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>
                    </h5>
                    <div id="fig_heatmap_worldcdt" style="width: 100%; min-width: 470px; min-height: 300px; height: 500px;">

                    </div>
                </div>
            </div><!-- /.card -->
        </div>

        <div class="col-lg-4" style="padding-left:8px; padding-right:8px;">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        Country Cases Trend | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button id="btn-toggle-us-mayo" type="button" class="btn btn-light"
                                onclick="fig_caseline_nations.reset_series();fig_deathline_nations.reset_series();">
                                RESET
                            </button>
                        </div>
                    </h5>
                    <div id="fig_caseline_nations" style="width: 100%; min-width: 200px; height: 220px;">

                    </div>
                </div>
            </div><!-- /.card -->

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa fa-chart-line"></i>
                        Country Mortality | 
                        <span class="txt-mn">
                            <i class="far fa-calendar-alt"></i>
                            <span class="last_update_date">mm/dd</span>
                        </span>

                        <div class="btn-group btn-group-sm" role="group" aria-label="Sites">
                            <button id="btn-toggle-us-mayo" type="button" class="btn btn-light"
                                onclick="fig_caseline_nations.reset_series();fig_deathline_nations.reset_series();">
                                RESET
                            </button>
                        </div>
                    </h5>
                    <div id="fig_deathline_nations" style="width: 100%; min-width: 200px; height: 220px;">

                    </div>
                </div>
            </div><!-- /.card -->

        </div>

    </div><!-- /.row -->

</div><!-- /.wrapper -->

<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The visualization used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer.<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers to access:<br><span style="font-size:1.2em;">' + location.href + '</span>';
}
</script>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    crossorigin="anonymous"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>

<script src="./static/lib/echarts/echarts.js"></script>

<!-- include other plots -->
<script>
// the figure js
var plots = {};

var vue_rgpanels = {
    plot_id: 'vue_rgpanels',
    plot_type: 'vue',
    vpp_id: '#vue_rgpanels',
    vpp: null,
    vpp_data: {},
    data: null,
    data_file: 'uscounty-data-latest.json',

    load: function() {
        $.get(
            './covid_data/' + this.data_file,
            {ver: Math.random()},
            function(data) {
                vue_rgpanels.init(data);
            }, 'json'
        );
    },

    init: function(data, regions) {
        this.data = data;
        // init the vue
        if (typeof(regions) == 'undefined') {
            regions = [{
                name: 'RST', fips: ['27099', '27109', '27139', '27169']
            }];
        }
        this.vpp_data = {
            regions: regions
        };
        this.vpp = new Vue({
            el: this.vpp_id,
            data: this.vpp_data,
            methods: {
                get_sign: function(v) {
                    if (v>0) {
                        return '+';
                    } else if (v<0) {
                        return ''
                    } else {
                        return '';
                    }
                },

                get_color: function(v) {
                    if (v>=0) { return 'green'; }
                    else { return 'red'; }
                },

                reg2disp: function(reg) {
                    if (reg == 'RST') {
                        return 'RST/SEMN';
                    }
                    return reg;
                }
            }
        });
    }
};
// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[vue_rgpanels.plot_id] = vue_rgpanels;
}

var figmker_cdtmap = {
    colorbar_title: 'Days',
    data_file: 'uscounty-data-latest.json',
    data: null,
    mapbox: {
        accesstoken: 'pk.eyJ1IjoiaGVodWFuMjExMiIsImEiOiJjazhudzg2ODgweWJ1M2Zremxub2VoY3MxIn0.JEycE3z3q8b7JX8f2XCw3Q',
        style: 'light'
    },
    valuescale: {
        TPT: [0, 1000],
        CDT: [0, 30],
    },
    colorscale: {
        TPT: [
            [0, 'rgba(255, 255, 255, 0.7)'],
            [1, 'rgba(240, 0, 0, 0.7']
        ],
        CDT: [
            [0, 'rgba(255, 0, 0, 0.5)'],
            [0.5, 'rgba(255, 255, 0, 0.5)'],
            [1, 'rgba(144, 238, 144, 0.5)']
        ],
    },

    init: function(data) {
        this.data = data;
    },

    make_fig: function(region, plot_id, data) {
        var fig = {
            plot_id: plot_id,
            get_view: this.get_view
        };
        var plot_dict = this.create_plot_data(
            region.fips_list,
            [32.84906395662327, -100.32481276712122, 3.187872300973526],
            data
        );
        fig.plot_dict = plot_dict;
        Plotly.newPlot(
            fig.plot_id, 
            fig.plot_dict.data,
            fig.plot_dict.layout,
            {responsive: true}
        );
        // update the last update
        $('#' + plot_id + '_last_update').html(data.last_update);
        return fig;
    },

    create_plot_data: function(countyFIPSList, view3, data) {
        var date = data.date;
        var rows = data.data;

        var mydata = {
            regions: []
        };

        var view = [0, 0, 6];
        for (let i = 0; i < countyFIPSList.length; i++) {
            const fips = countyFIPSList[i];
            if (rows.hasOwnProperty(fips)) {
                var d = rows[fips];
                view[0] += d.lat;
                view[1] += d.lon;
                var cdt = d.cdts[d.cdts.length - 1];
                var ncc = d.nccs[d.nccs.length - 1];
                var dth = d.dths[d.dths.length - 1];
                var sdr = d.sdrs[d.sdrs.length - 1];
                var new_cc = d.news[d.news.length - 1];
                var r = {
                    FIPS: fips,
                    val: cdt,
                    txt: d.countyName + ' on ' + date + '<br>' +
                        'CDT: <b>' + cdt.toFixed(1) + '</b> days<br>' +
                        'Total Cases:  <b>' + ncc.toFixed(0) + 
                            ' (' + new_cc.toFixed(0) + ')</b><br>' + 
                        'Total Deaths:  <b>' + dth.toFixed(0) + '</b><br>' +
                        'Mortality Rate:  <b>' + (sdr*100).toFixed(1) + '%</b>'
                }
                mydata.regions.push(r);
            }
        }
        view[0] = view[0] / countyFIPSList.length;
        view[1] = view[1] / countyFIPSList.length;

        var plot_data = [];
        plot_data.push({
            name: 'County<br>Detail',
            type: 'choroplethmapbox',
            locations: this.unpack(mydata.regions, 'FIPS'),
            text: this.unpack(mydata.regions, 'txt'),
            z: this.unpack(mydata.regions, 'val'),
            zmin: this.valuescale.CDT[0],
            zmax: this.valuescale.CDT[1],
            hovertemplate: '%{text}',
            geojson: './static/data/us-countymap-5m.json',
            colorscale: this.colorscale.CDT,
            showlegend: false,
            colorbar: {
                title: this.colorbar_title,
                thickness: 15,
                len: .5,
                x: 0.02,
                y: 0.75
            }
        });

        var plot_layout = {
            margin: { t: 0 , b: 0, l: 0, r: 0},
            mapbox: {
                accesstoken: this.mapbox.accesstoken,
                center: {
                    lat: view[0],
                    lon: view[1]
                },
                style: this.mapbox.style,
                zoom: view[2],
                gridshape: 'linear'
            }
        };

        return {
            data: plot_data, 
            layout: plot_layout
        };
    },


    get_color: function(v) {
        if (v>=0) { return 'green'; }
        else { return 'red'; }
    },

    get_sign: function(v) {
        if (v>0) {
            return '+';
        } else {
            return '';
        }
    },

    get_view: function() {
        return [
            this.plot_dict.layout.mapbox.center.lat,
            this.plot_dict.layout.mapbox.center.lon,
            this.plot_dict.layout.mapbox.zoom
        ];
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    },
};
var figmker_caseline = {
    data_file: 'uscounty-data-latest.json',
    make_fig: function(region, plot_id, data) {
        var dates = data.dates;
        var rows = data.data;
        var fig = {
            plot_id: plot_id,
            data: data
        };
        fig.series = [];

        var data_case = Array(data.dates.length).fill(0);
        var data_newcase = Array(data.dates.length).fill(0);
        for (let i = 0; i < region.fips_list.length; i++) {
            const fips = region.fips_list[i];
            if (rows.hasOwnProperty(fips)) {
                var d = rows[fips];
                
                for (let j = 0; j < dates.length; j++) {
                    data_case[j] += d.nccs[j];
                    data_newcase[j] += d.news[j];
                }
            }
        }

        // add the cum cases
        fig.series.push({
            name: 'Cumulative Cases',
            data: data_case,
            type: 'line',
            smooth: true,
            lineStyle: {
                width: 1.5,
                type: 'solid',
                color: 'darkred'
            },
            itemStyle: {
                color: 'darkred'
            },
            markPoint: {
                symbolSize: 40,
                label: {
                    fontSize: 10,
                    color: 'white'
                },
                data: [
                    {type: 'max', name: 'Max'}
                ]
            },
        });
        // add the new cases
        var value_last = data_newcase[data_newcase.length-1];
        fig.series.push({
            name: 'New Cases',
            data: data_newcase,
            type: 'line',
            smooth: true,
            yAxisIndex: 1,
            symbol: 'rect',
            symbolSize: 4,
            lineStyle: {
                width: 1.5,
                type: 'dotted',
                color: 'darkorange'
            },
            itemStyle: {
                color: 'darkorange'
            },
            markPoint: {
                symbolSize: 30,
                label: {
                    fontSize: 10,
                    color: 'white'
                },
                data: [
                    {type: 'max', name: 'Max'},
                    {
                        name: 'coordinate',
                        symbolSize: 35,
                        coord: [data.last_update, value_last],
                        value: value_last
                    }
                ]
            },
        });
        // config the plots
        var max_new_cases = Math.max.apply(null, data_newcase);
        var f_get_y1_max = function(value) {
            if (value.max < 100) {
                return 100;
            } else if (value.max < 1000) {
                return 1000;
            } else if (value.max < 10000) {
                return 10000;
            } else if (value.max < 100000) {
                return 100000;
            } else {
                return 300000;
            }
        };
        var f_get_y2_max = function(value) {
            if (value.max < 50) {
                return 50;
            } else if (value.max < 100) {
                return 100;
            } else if (value.max < 500) {
                return 500;
            } else if (value.max < 1000) {
                return 1000;
            } else if (value.max < 5000) {
                return 5000;
            } else if (value.max < 10000) {
                return 10000;
            }
        };
        fig.option = {
            tooltip: {
                trigger: 'axis'
            },
            grid: {
                top: 30,
                right: 40,
                bottom: 20,
                left: 45
            },
            legend: {
                data: ['New Cases', 'Cumulative Cases'],
                symbolKeepAspect: false,
                // left: 30,
                // right: 0,
                // itemWidth: 20,
                textStyle: {
                    fontSize: 10
                }
            },
            xAxis: {
                type: 'category',
                name: '',
                data: data.dates
            },
            yAxis: [{
                name: 'Total Cases',
                type: 'log',
                max: f_get_y1_max,
                min: 1
            }, {
                name: 'New Cases',
                type: 'value',
                splitLine: {
                    show: false
                },
                max: f_get_y2_max,
                min: 0
            }],
            series: fig.series
        };

        fig.plot_chart = echarts.init(document.getElementById(fig.plot_id));
        fig.plot_chart.setOption(fig.option);

        // resize!
        fig.resize = function() {
            if (this.plot_chart == null) {
    
            } else {
                this.plot_chart.resize();
            }
        }

        // update the last update
        $('#' + plot_id + '_last_update').html(data.last_update);

        return fig;
    }
};
var figmker_deathline = {
    data_file: 'uscounty-data-latest.json',
    make_fig: function(region, plot_id, data) {
        var dates = data.dates;
        var rows = data.data;
        var fig = {
            plot_id: plot_id,
            data: data
        };
        fig.series = [];

        var data_case = Array(data.dates.length).fill(0);
        var data_death = Array(data.dates.length).fill(0);
        for (let i = 0; i < region.fips_list.length; i++) {
            const fips = region.fips_list[i];
            if (rows.hasOwnProperty(fips)) {
                var d = rows[fips];
                
                for (let j = 0; j < dates.length; j++) {
                    data_case[j] += d.nccs[j];
                    data_death[j] += d.dths[j];
                }
            }
        }
        var data_dthr = [];
        for (let i = 0; i < data.dates.length; i++) {
            if (i<4) { data_dthr.push(null); }
            var sdr = ((data_death[i] - data_death[i-4]) / (data_case[i] - data_case[i-4] + 1 ));
            if (sdr > 0.15) { sdr = 0.15}
            data_dthr.push(
                (sdr * 100).toFixed(1)
            );
        }

        // add the cum deaths
        fig.series.push({
            name: 'Total Deaths',
            data: data_case,
            type: 'line',
            smooth: true,
            lineStyle: {
                width: 1.5,
                type: 'solid',
                color: 'black'
            },
            itemStyle: {
                color: 'black'
            },
            markPoint: {
                symbolSize: 40,
                label: {
                    fontSize: 10,
                    color: 'white'
                },
                data: [
                    {type: 'max', name: 'Max'}
                ]
            },
        });
        // add the death rate
        var value_last = data_dthr[data_dthr.length-1];
        fig.series.push({
            name: 'Death Rate',
            data: data_dthr,
            type: 'line',
            smooth: true,
            yAxisIndex: 1,
            symbol: 'rect',
            symbolSize: 4,
            lineStyle: {
                width: 1.5,
                type: 'dotted',
                color: 'grey'
            },
            itemStyle: {
                color: 'dimgrey'
            },
            markPoint: {
                symbolSize: 30,
                label: {
                    fontSize: 10,
                    color: 'white'
                },
                data: [
                    {type: 'max', name: 'Max'},
                    {
                        name: 'coordinate',
                        symbolSize: 35,
                        coord: [data.date, value_last],
                        value: value_last
                    }
                ]
            },
        });
        // config the plots
        var f_get_y1_max = function(value) {
            if (value.max < 500) {
                return 500;
            } else if (value.max < 1000) {
                return 1000;
            } else if (value.max < 5000) {
                return 5000;
            } else if (value.max < 10000) {
                return 10000;
            }
        };
        fig.option = {
            tooltip: {
                trigger: 'axis'
            },
            grid: {
                top: 30,
                right: 40,
                bottom: 20,
                left: 45
            },
            legend: {
                data: ['Total Deaths', 'Death Rate'],
                symbolKeepAspect: false,
                // left: 30,
                // right: 0,
                // itemWidth: 20,
                textStyle: {
                    fontSize: 10
                }
            },
            xAxis: {
                type: 'category',
                name: '',
                data: data.dates
            },
            yAxis: [{
                name: 'Total Deaths',
                type: 'value',
                max: f_get_y1_max
            }, {
                name: 'Death Rate',
                type: 'value',
                splitLine: {
                    show: false
                },
                axisLabel: {
                    formatter: function (val) {
                        return val + '%';
                    }
                },
                max: 20
            }],
            series: fig.series
        };

        fig.plot_chart = echarts.init(document.getElementById(fig.plot_id));
        fig.plot_chart.setOption(fig.option);

        // resize!
        fig.resize = function() {
            if (this.plot_chart == null) {
    
            } else {
                this.plot_chart.resize();
            }
        }

        // update the last update
        $('#' + plot_id + '_last_update').html(data.last_update);

        return fig;
    }
};

var fig_heatmap_uscntycdt = {
    plot_id: 'fig_heatmap_uscntycdt',
    plot_elm: null,
    plot_dict: null,
    plot_type: 'plotly',
    mapbox: {
        accesstoken: 'pk.eyJ1IjoiaGVodWFuMjExMiIsImEiOiJjazhudzg2ODgweWJ1M2Zremxub2VoY3MxIn0.JEycE3z3q8b7JX8f2XCw3Q',
        style: 'light'
    },
    colorbar_title: 'Days',
    cdt_max: 30,
    colorscale: {
        CDT: [
            [0, 'rgba(255, 0, 0, 0.5)'],
            [0.5, 'rgba(255, 255, 0, 0.5)'],
            [1, 'rgba(144, 238, 144, 0.5)']
        ],
    },
    data: null,
    data_file: 'uscounty-data-latest.json',

    FIPS2State: {
        '01': { name: 'Alabama', code: 'AL' },
        '02': { name: 'Alaska', code: 'AK' },
        '04': { name: 'Arizona', code: 'AZ' },
        '05': { name: 'Arkansas', code: 'AR' },
        '06': { name: 'California', code: 'CA' },
        '08': { name: 'Colorado', code: 'CO' },
        '09': { name: 'Connecticut', code: 'CT' },
        '10': { name: 'Delaware', code: 'DE' },
        '11': { name: 'District Of Columbia', code: 'DC' },
        '12': { name: 'Florida', code: 'FL' },
        '13': { name: 'Georgia', code: 'GA' },
        '15': { name: 'Hawaii', code: 'HI' },
        '16': { name: 'Idaho', code: 'ID' },
        '17': { name: 'Illinois', code: 'IL' },
        '18': { name: 'Indiana', code: 'IN' },
        '19': { name: 'Iowa', code: 'IA' },
        '20': { name: 'Kansas', code: 'KS' },
        '21': { name: 'Kentucky', code: 'KY' },
        '22': { name: 'Louisiana', code: 'LA' },
        '23': { name: 'Maine', code: 'ME' },
        '24': { name: 'Maryland', code: 'MD' },
        '25': { name: 'Massachusetts', code: 'MA' },
        '26': { name: 'Michigan', code: 'MI' },
        '27': { name: 'Minnesota', code: 'MN' },
        '28': { name: 'Mississippi', code: 'MS' },
        '29': { name: 'Missouri', code: 'MO' },
        '30': { name: 'Montana', code: 'MT' },
        '31': { name: 'Nebraska', code: 'NE' },
        '32': { name: 'Nevada', code: 'NV' },
        '33': { name: 'New Hampshire', code: 'NH' },
        '34': { name: 'New Jersey', code: 'NJ' },
        '35': { name: 'New Mexico', code: 'NM' },
        '36': { name: 'New York', code: 'NY' },
        '37': { name: 'North Carolina', code: 'NC' },
        '38': { name: 'North Dakota', code: 'ND' },
        '39': { name: 'Ohio', code: 'OH' },
        '40': { name: 'Oklahoma', code: 'OK' },
        '41': { name: 'Oregon', code: 'OR' },
        '42': { name: 'Pennsylvania', code: 'PA' },
        '44': { name: 'Rhode Island', code: 'RI' },
        '45': { name: 'South Carolina', code: 'SC' },
        '46': { name: 'South Dakota', code: 'SD' },
        '47': { name: 'Tennessee', code: 'TN' },
        '48': { name: 'Texas', code: 'TX' },
        '49': { name: 'Utah', code: 'UT' },
        '50': { name: 'Vermont', code: 'VT' },
        '51': { name: 'Virginia', code: 'VA' },
        '53': { name: 'Washington', code: 'WA' },
        '54': { name: 'West Virginia', code: 'WV' },
        '55': { name: 'Wisconsin', code: 'WI' },
        '56': { name: 'Wyoming', code: 'WY' },
        '60': { name: 'American Samoa', code: 'AS' },
        '66': { name: 'Guam', code: 'GU' },
        '69': { name: 'Northern Mariana Islands', code: 'MP' },
        '72': { name: 'Puerto Rico', code: 'PR' },
        '78': { name: 'Virgin Islands', code: 'VI' },
    },

    area: {
        SWMN: [44.02907899472882, -94.3890149890982, 6.504512558724205],
        SWWI: [44.02850002190516, -91.14599583630508, 6.436584781196458],
        NWWI: [45.05152269286285, -91.42584363926721, 6.229056098694206],
        PHX:  [34.544938344671905, -111.95353291577072, 4.506340326068152],
        JAX:  [30.736528159343408, -81.94074851482583, 5.858222918792623],
        RST:  [44.18972577500327, -92.52786083477628, 6.134125167316714],
        default: [37.99494712856239, -95.91207942023868, 3.359274942537943]
    },

    load: function() {
        $.when(
            $.get('./static/data/us-countymap-5m.json', {}),
            $.get('./read_data_file', {fn: this.data_file, ver: Math.random()})
        ).done(function(data1, data2) {
            fig_heatmap_uscntycdt.set_all_counties(data1[0]);
            fig_heatmap_uscntycdt.init(data2[0]);
        });
    },

    set_all_counties: function(data) {
        this.data_geo = data;
        this.all_counties = d3.map();
        for (let i = 0; i < data.features.length; i++) {
            const f = data.features[i];
            // create a new county obj
            var county = {
                FIPS: f.id,
                countyName: f.properties.NAME,
                state: this.FIPS2State[f.properties.STATE].name,
                has_case: false,
                data: null
            };
            
            this.all_counties.set(f.id, county);
        }
    },

    convert_data_to_dict: function() {
        this.data_dict = d3.map();
        for (const FIPS in this.data.data) {
            if (this.data.data.hasOwnProperty(FIPS)) {
                const cnty = this.data.data[FIPS];
                this.data_dict.set(FIPS, cnty);
            }
        }
    },

    init: function(data) {
        this.data = data;
        this.create_plot_dict();
        this.convert_data_to_dict();

        Plotly.newPlot(
            this.plot_id, 
            this.plot_dict.data,
            this.plot_dict.layout,
            {responsive: true}
        );

        $('#' + this.plot_id + '_last_update').html(data.date);

        this.bind_click_event();
    },

    bind_click_event: function() {
        // bind click events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_click', function(data) {
            console.log(data);
            var FIPS = data.points[0].properties.STATE + data.points[0].properties.COUNTY;
            // hope jarvis has this ablity!
            console.log("* clicked on " + FIPS);
            jarvis.add_county_series(FIPS);
        });

        this.plot_elm.on('plotly_selected', function(data) {
            data.points.forEach(function(p) {
                var FIPS = p.properties.STATE + p.properties.COUNTY;
                jarvis.add_county_series(FIPS);
            });

        });
    },

    _update: function() {
        Plotly.update(this.plot_id, this.plot_dict);
    },

    _relayout: function(update) {
        Plotly.relayout(this.plot_id, update);
    },

    get_color: function(v) {
        if (v>=0) { return 'green'; }
        else { return 'red'; }
    },

    get_sign: function(v) {
        if (v>0) {
            return '+';
        } else {
            return '';
        }
    },

    create_plot_dict: function(filter) {
        var date = this.data.date;
        var rows = this.data.data;
        var mydata = {
            regions: []
        };
        var mydata_0case = {
            regions: []
        };

        // get all the counties with cases
        for (const FIPS in this.data.data) {
            const r = this.data.data[FIPS];

            if (typeof(filter) != 'undefined') {
                var cdt = r.cdts[r.cdts.length-1];
                if (filter(cdt)) {
                    // keep those comply the filter condition
                } else {
                    continue;
                }
            }
            var ncc = r.nccs[r.nccs.length-1];
            if (ncc == 0) {
                continue;
            }
            r.val = r.cdts[r.cdts.length-1].toFixed(2);

            var cdt = r.cdts[r.cdts.length-1];
            var dth = r.dths[r.dths.length-1];
            var sdr = r.sdrs[r.sdrs.length-1] * 100;
            var cdr = dth / ncc * 100;

            // ok, when we build the txt
            r.txt = r.countyName + ', ' + r.state + ' on ' + date + '<br>' +
                'CDT: <b>' + r.val + '</b> days ' +
                    '(<span class="txt-'+this.get_color(r.d_cdt)+'">'+ this.get_sign(r.d_cdt) + 
                    r.d_cdt.toFixed(1) +'</span>)<br>' +
                'Total Cases:  <b>' + ncc.toFixed(0) + 
                    ' (' + this.get_sign(r.d_ncc) + r.d_ncc.toFixed(0) + ')</b><br>' + 
                'Total Deaths:  <b>' + dth.toFixed(0) + 
                    ' (' + this.get_sign(r.d_dth) + r.d_dth.toFixed(0) + ')</b><br>' +
                'Death Rate:  <b>' + cdr.toFixed(1) + '%</b><br>' +
                'Death Rate(4-day Smoothed):  <b>' + sdr.toFixed(1) + '%</b>';

            mydata.regions.push(r);

            // update the all counties
            var cnty = this.all_counties.get(r.FIPS);
            if (cnty == null) {
                // pass, we don't have data for this area
                console.log('* missing geo data for', r.FIPS, r.countyName + ', ' + r.state)
            } else {
                cnty['has_case'] = true;
                cnty['data'] = r;
            }
        }

        // get those counties without case
        var all_cnty = this.all_counties.values();
        for (let i = 0; i < all_cnty.length; i++) {
            const cnty = all_cnty[i];
            if (cnty.has_case) {
                continue;
            }
            var r = {
                FIPS: cnty.FIPS,
                val: this.cdt_max,
                txt: cnty.countyName + ', ' + cnty.State + ' on ' + date + '<br>' +
                    'No confirmed COVID-19 case'
            }
            if (typeof(filter) != 'undefined') {
                if (filter(r.val)) {
                    // keep those comply the filter condition
                } else {
                    continue;
                }
            }
            mydata_0case.regions.push(r);
        }
        
        var plot_data = [];

        // those counties with case
        plot_data.push({
            name: 'County<br>Data',
            type: 'choroplethmapbox',
            locations: this.unpack(mydata.regions, 'FIPS'),
            text: this.unpack(mydata.regions, 'txt'),
            z: this.unpack(mydata.regions, 'val'),
            hovertemplate: '%{text}',
            zmin: 0,
            zmid: this.cdt_max / 2,
            zmax: this.cdt_max,
            geojson: './static/data/us-countymap-5m.json',
            colorscale: this.colorscale.CDT,
            colorbar: {
                title: this.colorbar_title,
                thickness: 15,
                len: .3,
                x: 0.02,
                y: 0.23
            }
        });

        // those counties with 0 case
        plot_data.push({
            name: '0 Case<br>County',
            type: 'choroplethmapbox',
            locations: this.unpack(mydata_0case.regions, 'FIPS'),
            text: this.unpack(mydata_0case.regions, 'txt'),
            z: this.unpack(mydata_0case.regions, 'val'),
            hovertemplate: '%{text}',
            zmin: 0,
            zmid: this.cdt_max / 2,
            zmax: this.cdt_max,
            geojson: './static/data/us-countymap-5m.json',
            colorscale: this.colorscale.CDT,
            showscale: false
        });
        
        this.plot_dict = {
            data: plot_data,
            layout: {
                margin: { t: 0 , b: 0, l: 0, r: 0},
                mapbox: {
                    accesstoken: this.mapbox.accesstoken,
                    center: {
                        lat: this.area.default[0],
                        lon: this.area.default[1]
                    },
                    style: this.mapbox.style,
                    zoom: this.area.default[2]
                }
            }
        };
    },

    set_view_to(name) {
        var update = {
            mapbox: {
                accesstoken: this.mapbox.accesstoken,
                style: this.mapbox.style,
                center: {
                    lat: this.area[name][0],
                    lon: this.area[name][1]
                },
                zoom: this.area[name][2]
            }
        }
        this._relayout(update);
    },

    set_view: function(view) {
        var update = {
            mapbox: {
                accesstoken: this.mapbox.accesstoken,
                style: this.mapbox.style,
                center: {
                    lat: view[0],
                    lon: view[1]
                },
                zoom: view[2]
            }
        }
        this._relayout(update);
    },

    get_view: function() {
        return [
            this.plot_dict.layout.mapbox.center.lat,
            this.plot_dict.layout.mapbox.center.lon,
            this.plot_dict.layout.mapbox.zoom
        ];
    },

    filter_by_cdt: function(a, b) {
        if (b > 0) {
            var f = function(v) {
                if (v > a && v <= b) {
                    return true;
                } else {
                    return false;
                }
            };
            this.create_plot_dict(f);
        } else {
            this.create_plot_dict();
        }
        Plotly.purge(this.plot_id);
        Plotly.newPlot(this.plot_id, this.plot_dict);

        this.bind_click_event();
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    }
};
// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_heatmap_uscntycdt.plot_id] = fig_heatmap_uscntycdt;
}
var fig_heatmap_usstatecdt = {
    plot_id: 'fig_heatmap_usstatecdt',
    plot_elm: null,
    plot_dict: null,
    plot_type: 'plotly',
    data: null,
    data_file: 'usstate-data-latest.json',
    mapbox: {
        accesstoken: 'pk.eyJ1IjoiaGVodWFuMjExMiIsImEiOiJjazhudzg2ODgweWJ1M2Zremxub2VoY3MxIn0.JEycE3z3q8b7JX8f2XCw3Q',
        style: 'light'
    },
    colorbar_title: 'Days',
    cdt_max: 30,
    colorscale: {
        CDT: [
            [0, 'rgba(255, 0, 0, 0.7)'],
            [0.5, 'rgba(255, 255, 0, 0.7)'],
            [1, 'rgba(144, 238, 144, 0.7)']
        ],
    },
    fmt_comma: d3.format(","),

    area: {
        default: {
            center: [38, -96],
            zoom: 3.4
        }
    },

    load: function() {
        $.get(
            './covid_data/' + this.data_file,
            {ver: Math.random()},
            function(data) {
                fig_heatmap_usstatecdt.init(data);
            }, 'json'
        );
    },

    init: function(data) {
        this.data = data;
        var mydata = this.create_plot_data();

        var plot_data = [];

        plot_data.push({
            name: 'State<br>Data',
            type: 'choropleth',
            locationmode: 'USA-states',
            locations: this.unpack(mydata.regions, 'state'),
            text: this.unpack(mydata.regions, 'txt'),
            z: this.unpack(mydata.regions, 'val'),
            hovertemplate: '%{text}',
            zmin: 0,
            zmid: this.cdt_max/2,
            zmax: this.cdt_max,
            colorscale: this.colorscale.CDT,
            colorbar: {
                title: this.colorbar_title,
                thickness: 15,
                len: .3,
                x: 0.9,
                y: 0.83
            }
        });

        this.plot_dict = {
            data: plot_data,
            layout: {
                height: this.get_height(),
                margin: { t: 10 , b: 10, l: 12, r: 12},
                geo: {
                    scope: 'usa',
                    showlakes: true,
                    lakecolor: 'rgb(255,255,255)'
                }
            }
        };

        Plotly.newPlot(
            this.plot_id, 
            this.plot_dict.data,
            this.plot_dict.layout,
            {responsive: true}
        );
        // update the last update
        $('#' + this.plot_id + '_last_update').html(data.date);

        this.bind_click_event();
    },

    bind_click_event: function() {
        // bind click events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_click', function(data) {
            var state = data.points[0].location;
            jarvis.add_state_series(state);
        });
    },
    
    create_plot_data: function() {
        var date = this.data.date;
        var dates = this.data.dates;
        var rows = this.data.data;
        var mydata = {
            regions: []
        };

        for (const state in rows) {
            if (rows.hasOwnProperty(state)) {
                const obj = rows[state];
                var cdt = obj.cdts[obj.cdts.length - 1];
                var ncc = obj.nccs[obj.nccs.length - 1];
                var dth = obj.dths[obj.dths.length - 1];
                var sdr = obj.sdrs[obj.dths.length - 1] * 100;
                var cdr = dth / ncc * 100;
                var r = {
                    state: state,
                    val: cdt,
                    txt: state + ' on ' + date + ' <br>' +
                        'CDT: ' + cdt.toFixed(1) + ' days (' + obj.d_cdt.toFixed(1) +')<br>' +
                        'Total Cases: ' + this.fmt_comma(ncc) + ' (' + obj.d_ncc.toFixed(0) + ')<br>' + 
                        'Total Death: ' + this.fmt_comma(dth) + ' (' + obj.d_dth.toFixed(0) + ')<br>' + 
                        'Death Rate: ' + cdr.toFixed(1) + '%<br>' + 
                        'Death Rate(4-day Smoothed): ' + sdr.toFixed(1) + '%<br>'
                };
                mydata.regions.push(r);
            }
        }

        return mydata;
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    },


    get_width: function() {
        var w = $('#' + this.plot_id).css('width');
        w = parseFloat(w.substring(0, w.length-2));
        console.log('* ' + this.plot_id + ' width: ' + w);
        
        var widths = [];
        if (w < 100) {
            // ask help !!!
            // 40 is the padding of the container
            w = jarvis.guess_width(this.plot_id) - 40;
            if (w == 0) {
                w = this.default_width;
            }
        }

        return w;
    },

    get_height: function() {
        var h = $('#' + this.plot_id).css('height');
        h = parseFloat(h.substring(0, h.length-2));
        console.log('* ' + this.plot_id + ' height: ' + h);

        if (h < 200) {
            var width = this.get_width();
            return width * 0.6;
        } else {
            return h;
        }

    },

};
// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_heatmap_usstatecdt.plot_id] = fig_heatmap_usstatecdt;
}
var fig_heatmap_worldcdt = {
    plot_id: 'fig_heatmap_worldcdt',
    plot_dict: null,
    plot_type: 'plotly',
    
    colorbar_title: 'Days',
    cdt_max: 30,
    colorscale: {
        CDT: [
            [0, 'rgba(255, 0, 0, 0.6)'],
            [0.5, 'rgba(255, 255, 0, 0.6)'],
            [1, 'rgba(144, 238, 144, 0.6)']
        ],
    },
    data: null,
    fmt_comma: d3.format(","),
    data_file: 'world-data-latest.json',

    get_color: function(v) {
        if (v>=0) { return 'green'; }
        else { return 'red'; }
    },

    get_sign: function(v) {
        if (v>0) {
            return '+';
        } else {
            return '';
        }
    },
    

    load: function() {
        $.get(
            './covid_data/' + this.data_file, 
            {ver: Math.random()},
            function(data) {
                fig_heatmap_worldcdt.init(data);
            },
            'json'
        );
    },

    init: function(data) {
        this.data = data;
        var date = data.date;
        var rows = data.data;
        var mydata = [];
        for (const country in rows) {
            if (rows.hasOwnProperty(country)) {
                const obj = rows[country];
                // console.log('* country: ' + country);
                
                var cdt = obj.cdts[obj.cdts.length - 1];
                var ncc = obj.cases[obj.cases.length - 1];
                var d_ncc = obj.newcases[obj.newcases.length - 1];
                var dth = obj.deaths[obj.deaths.length - 1];
                var d_dth = dth - obj.deaths[obj.deaths.length - 2];
                var sdr = obj.sdrs[obj.sdrs.length - 1] * 100;
                var cdr = '--';
                if (ncc > 0) {
                    cdr = dth / ncc * 100;
                    cdr = cdr.toFixed(1) + '%';
                }
                var r = {
                    country: country,
                    cdt: obj.cdts[obj.cdts.length - 1],
                    txt: "<b>" + country + '</b> on ' + date + '<br>' + 
                        'CDT: <b>' + cdt.toFixed(1) + '</b> days <br>' +
                        'Total Cases:  <b>' + this.fmt_comma(ncc) + 
                            ' (' + this.get_sign(d_ncc) + this.fmt_comma(d_ncc) + ')</b><br>' + 
                        'Total Deaths:  <b>' + this.fmt_comma(dth) + 
                            ' (' + this.get_sign(d_dth) + this.fmt_comma(d_dth) + ')</b><br>' + 
                        'Death Rate:  <b>' + cdr + '</b><br>' + 
                        'Death Rate(4-day Smoothed): <b>'+ sdr.toFixed(1) + '%</b>'
                }
                mydata.push(r);
            }
        }
        
        var plot_data = [{
            name: 'Country<br>Data',
            type: 'choropleth',
            locationmode: 'country names',
            locations: this.unpack(mydata, 'country'),
            z: this.unpack(mydata, 'cdt'),
            text: this.unpack(mydata, 'txt'),
            hovertemplate: '%{text}',
            
            zmin: 0,
            zmid: this.cdt_max / 2,
            zmax: this.cdt_max,
            colorscale: this.colorscale.CDT,
            colorbar: {
                title: this.colorbar_title,
                thickness: 15,
                len: .4,
                x: 0.05,
                y: 0.35
            }
        }];
        
        this.plot_dict = {
            data: plot_data,
            layout: {
                height: this.get_height(),
                margin: { t: 10 , b: 10, l: 12, r: 12},
                geo: {
                    projection: {
                        type: 'equirectangular'
                    }
                }
            }
        };

        Plotly.newPlot(
            this.plot_id, 
            this.plot_dict.data,
            this.plot_dict.layout,
            {responsive: true}
        );
        // update the last update
        $('#' + this.plot_id + '_last_update').html(data.date);

        this.bind_click_event();
    },
    

    bind_click_event: function() {
        // bind click events
        this.plot_elm = document.getElementById(this.plot_id);
        this.plot_elm.on('plotly_click', function(data) {
            var nation = data.points[0].location;
            jarvis.add_nation_series(nation);
        });
    },

    get_width: function() {
        var w = $('#' + this.plot_id).css('width');
        return parseFloat(w.substring(0, w.length-2));
    },

    get_height: function() {
        var h = $('#' + this.plot_id).css('height');
        h = parseFloat(h.substring(0, h.length-2));

        if (h >= 300) {
            return h;
        } else {
            var width = this.get_width();
            if (width > 500) {
                return width * 0.5;
            } else {
                return 300;
            }
        }
    },
    

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    }

};
// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_heatmap_worldcdt.plot_id] = fig_heatmap_worldcdt;
}

var fig_casedeathline_cntys = {
    plot_id: 'fig_casedeathline_cntys',
    plot_type: 'echarts',
    plot_chart: null,
    
    dates: [],
    items: [],
    series: [],

    colors: ['#c23531','#2f4554', '#61a0a8', '#d48265', '#91c7ae','#749f83',  '#ca8622', '#bda29a','#6e7074', '#546570', '#c4ccd3'],

    data_file: 'uscounty-data-latest.json',

    load: function() {
        
        $.get(
            './read_data_file',
            {fn:this.data_file, ver: Math.random()},
            function(data) {
                fig_casedeathline_cntys.init(data);
                // use US as default
                fig_casedeathline_cntys.reset_series();
            }, 'json'
        );
    },

    /*
     data is {
         name: 'xxx',
         data: [1,2,3]
     }
     */
    add_series: function(data) {
        data.symbolSize = 2;
        data['type'] = 'line';
        data['smooth'] = true;
        // update option
        this.series.push(data);
        this.option.series = this.series;
        this.items.push(data.name);
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    add_series_by_FIPS: function(FIPS) {
        var cnty = this.data_dict.get(FIPS);
        var series_name = cnty.countyName + ',' + cnty.state;
        // check if this exist
        for (let i = 0; i < this.series.length; i++) {
            const s = this.series[i];
            if (s.name == series_name) {
                // oh, this has been added!
                return -1;
            }
        }
        var data = {
            name: series_name,
            data: cnty.nccs,
            itemStyle: {
                color: this.colors[Math.floor(this.series.length/2) % 10]
            },
            lineStyle: {
                width: 1,
                color: this.colors[Math.floor(this.series.length/2) % 10],
                type: 'solid'
            }
        };
        this.add_series(data);

        var cdrs = cnty.dths.map((v, i)=> (v/cnty.nccs[i] * 100).toFixed(1));
        var sdrs = cnty.sdrs.map((v)=>(v*100).toFixed(1));
        var data2 = {
            name: cnty.countyName + ',' + cnty.state + ' Death Rate',
            yAxisIndex: 1,
            data: cdrs,
            symbol: 'rect',
            itemStyle: {
                color: this.colors[Math.floor(this.series.length/2) % 10]
            },
            lineStyle: {
                width: 1,
                color: this.colors[Math.floor(this.series.length/2) % 10],
                type: 'dotted'
            }
        };
        this.add_series(data2);
    },

    reset_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;
        this.plot_chart.setOption(this.option, true);
        // var defaults = [
        //     ['Maricopa,AZ', '04013'],
        //     ['Duval,FL', '12031'],
        //     ['Olmsted,MN', '27109'],
        // ];
        // for (let i = 0; i < defaults.length; i++) {
        //     const c = defaults[i];
        //     this.add_series_by_FIPS(c[1]);
        // }
    },

    convert_data_to_dict: function() {
        this.data_dict = d3.map();
        for (const FIPS in this.data.data) {
            if (this.data.data.hasOwnProperty(FIPS)) {
                const cnty = this.data.data[FIPS];
                this.data_dict.set(FIPS, cnty);
            }
        }
    },

    clear_all_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;
        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    init: function(data) {
        this.data = data;
        this.convert_data_to_dict();

        this.dates = data.dates;
        this.items = [];
        this.series = [];

        this.option = {
            tooltip: {
                trigger: 'axis'
            },
            grid: {
                top: 40,
                right: 50,
                bottom: 20,
                left: 50
            },
            legend: {
                data: this.items,
                left: 85,
                right: 70,
                itemWidth: 20,
                textStyle: {
                    fontSize: 9
                }
            },
            xAxis: {
                type: 'category',
                data: this.dates
            },
            yAxis: [{
                name: 'Cum.Cases',
                type: 'log',
                min: 1
            }, {
                name: 'Cum. Death Rate',
                type: 'value',
                splitLine: {
                    show: false
                },
                axisLabel: {
                    formatter: function (val) {
                        return val + '%';
                    }
                },
                max: 20
            }],
            series: this.series
        };

        this.plot_chart = echarts.init(document.getElementById(this.plot_id));
        this.plot_chart.setOption(this.option);

        // update the date
        $('#' + this.plot_id + '_last_update').html(data.date);
    },

    resize: function() {
        if (this.plot_chart == null) {

        } else {
            this.plot_chart.resize();
        }
    }
};

// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_casedeathline_cntys.plot_id] = fig_casedeathline_cntys;
}
var fig_caseline_states = {
    plot_id: 'fig_caseline_states',
    plot_type: 'echarts',
    plot_chart: null,
    data_file: 'usstate-data-dict-latest.json',
    
    dates: [],
    items: [],
    series: [],

    load: function() {
        $.get(
            './read_data_file',
            {fn:this.data_file, ver: Math.random()},
            function(data) {
                fig_caseline_states.init(data);
            }, 'json'
        );
    },

    add_series_by_state: function(state) {
        // check if this exist
        for (let i = 0; i < this.series.length; i++) {
            const s = this.series[i];
            if (s.name == state) {
                // oh, this has been added!
                return -1;
            }
        }
        var data = {
            name: state,
            data: this.data.dates.map((v)=>(this.data.data[state][v].test_pos).toFixed(0))
        };
        this.add_series(data);
    },

    /*
     data is {
         name: 'xxx',
         data: [1,2,3]
     }
     */
    add_series: function(data) {
        data.symbolSize = 2;
        data['type'] = 'line';
        data['smooth'] = true;
        data['lineStyle'] = {
            width: 1,
            type: 'solid'
        };
        // update option
        this.series.push(data);
        this.option.series = this.series;
        this.items.push(data.name);
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    reset_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;
        // update chart
        this.plot_chart.setOption(this.option, true);

        // var defaults = ['AZ', 'FL', 'MN'];
        // for (let i = 0; i < defaults.length; i++) {
        //     const state = defaults[i];
        //     this.add_series_by_state(state);
        // }
    },

    clear_all_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;
        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    init: function(data) {
        this.data = data;
        this.dates = data.dates;
        this.items = [];
        this.series = [];

        this.option = {
            tooltip: {
                trigger: 'axis'
            },
            grid: {
                top: 30,
                right: 20,
                bottom: 20,
                left: 50
            },
            legend: {
                data: this.items,
                left: 65,
                right: 5,
                itemWidth: 20,
                textStyle: {
                    fontSize: 9
                }
            },
            xAxis: {
                type: 'category',
                data: this.dates
            },
            yAxis: {
                name: 'Cum.Cases',
                type: 'log'
            },
            series: this.series
        };

        this.plot_chart = echarts.init(document.getElementById(this.plot_id));
        this.plot_chart.setOption(this.option);
        
        // update the date
        $('#' + this.plot_id + '_last_update').html(data.date);
    },

    resize: function() {
        if (this.plot_chart == null) {

        } else {
            this.plot_chart.resize();
        }
    }
};

// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_caseline_states.plot_id] = fig_caseline_states;
}
var fig_caseline_nations = {
    plot_id: 'fig_caseline_nations',
    plot_type: 'echarts',
    plot_chart: null,
    data_file: 'world-data-latest.json',

    fmt_comma: d3.format(","),
    
    dates: [],
    items: [],
    series: [],

    load: function() {
        $.get(
            './read_data_file',
            {fn:this.data_file, ver: Math.random()},
            function(data) {
                fig_caseline_nations.init(data);

                // use US as default
                fig_caseline_nations.add_series_by_nation('US')

            }, 'json'
        );
    },

    add_series_by_nation: function(nation) {
        // check if this exist
        for (let i = 0; i < this.series.length; i++) {
            const s = this.series[i];
            if (s.name == nation) {
                // oh, this has been added!
                return -1;
            }
        }
        var data = {
            name: nation,
            data: this.data.data[nation].cases.map(function(v, idx) {
                // return [idx+1, v];
                return [
                    v, 
                    fig_caseline_nations.data.data[nation].newcases[idx], 
                    fig_caseline_nations.data.data[nation].dates[idx]
                ];
            })
        };
        this.add_series(data);
    },

    /*
     data is {
         name: 'xxx',
         data: [1,2,3]
     }
     */
    add_series: function(data) {
        data.symbolSize = 2;
        data['type'] = 'line';
        data['smooth'] = true;
        data['lineStyle'] = {
            width: 1,
            type: 'solid'
        };
        data.tooltip = {
            formatter: function(params) {
                console.log(params);

                return 'OK'
            }
        };
        // update option
        this.series.push(data);
        this.option.series = this.series;
        this.items.push(data.name);
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    reset_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;

        // leave only us
        this.add_series_by_nation('US');
    },

    clear_all_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    init: function(data) {
        this.data = data;
        this.dates = data.dates;
        this.items = [];
        this.series = [];

        this.option = {
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    // console.log(params);
                    var str = '';
                    for (let i = 0; i < params.length; i++) {
                        const param = params[i];
                        str += param.seriesName + ' on ' + param.value[2] + '<br>' +
                            'Total cases: ' + fig_caseline_nations.fmt_comma(param.value[0]) + '<br>' + 
                            'New cases: ' + fig_caseline_nations.fmt_comma(param.value[1]) + '<br>';
                    }
                    return str;
                }
            },
            grid: {
                top: 30,
                right: 25,
                bottom: 33,
                left: 60
            },
            legend: {
                data: this.items,
                left: 90,
                right: 5,
                itemWidth: 20,
                textStyle: {
                    fontSize: 9
                }
            },
            xAxis: {
                type: 'log',
                name: 'Total cases',
                nameGap: 20,
                nameLocation: 'center'
            },
            yAxis: {
                name: 'New cases',
                type: 'log',
                min: 1
            },
            series: this.series
        };

        this.plot_chart = echarts.init(document.getElementById(this.plot_id));
        this.plot_chart.setOption(this.option);
        
        // update the date
        $('#' + this.plot_id + '_last_update').html(data.date);
    },

    resize: function() {
        if (this.plot_chart == null) {

        } else {
            this.plot_chart.resize();
        }
    }
};

// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_caseline_nations.plot_id] = fig_caseline_nations;
}

var fig_cdtline_cntys = {
    plot_id: 'fig_cdtline_cntys',
    plot_type: 'echarts',
    plot_chart: null,
    
    dates: [],
    items: [],
    series: [],

    data_file: 'uscounty-data-latest.json',

    load: function() {
        
        $.get(
            './read_data_file',
            {fn:this.data_file, ver: Math.random()},
            function(data) {
                fig_cdtline_cntys.init(data);
                // use US as default
                fig_cdtline_cntys.reset_series();
            }, 'json'
        );
    },

    /*
     data is {
         name: 'xxx',
         data: [1,2,3]
     }
     */
    add_series: function(data) {
        data.symbolSize = 2;
        data['type'] = 'line';
        data['smooth'] = true;
        data['lineStyle'] = {
            width: 1,
            type: 'solid'
        };
        // update option
        this.series.push(data);
        this.option.series = this.series;
        this.items.push(data.name);
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    add_series_by_FIPS: function(FIPS) {
        var cnty = this.data_dict.get(FIPS);
        var series_name = cnty.countyName + ',' + cnty.state;
        // check if this exist
        for (let i = 0; i < this.series.length; i++) {
            const s = this.series[i];
            if (s.name == series_name) {
                // oh, this has been added!
                return -1;
            }
        }
        var data = {
            name: series_name,
            data: cnty.cdts.map((v)=>v.toFixed(1))
        };
        this.add_series(data);
    },

    reset_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;
        this.plot_chart.setOption(this.option, true);
        
        // var defaults = [
        //     ['Maricopa,AZ', '04013'],
        //     ['Duval,FL', '12031'],
        //     ['Olmsted,MN', '27109'],
        // ];
        // for (let i = 0; i < defaults.length; i++) {
        //     const c = defaults[i];
        //     this.add_series_by_FIPS(c[1]);
        // }
    },

    convert_data_to_dict: function() {
        this.data_dict = d3.map();
        for (const FIPS in this.data.data) {
            if (this.data.data.hasOwnProperty(FIPS)) {
                const cnty = this.data.data[FIPS];
                this.data_dict.set(FIPS, cnty);
            }
        }
    },

    clear_all_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;
        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    init: function(data) {
        this.data = data;
        this.convert_data_to_dict();

        this.dates = data.dates;
        this.items = [];
        this.series = [];

        this.option = {
            tooltip: {
                trigger: 'axis'
            },
            grid: {
                top: 35,
                right: 10,
                bottom: 20,
                left: 50
            },
            legend: {
                data: this.items,
                left: 75,
                right: 0,
                itemWidth: 20,
                textStyle: {
                    fontSize: 9
                }
            },
            xAxis: {
                type: 'category',
                data: this.dates
            },
            yAxis: {
                name: 'Days',
                type: 'value',
                max: 60
            },
            series: this.series
        };

        this.plot_chart = echarts.init(document.getElementById(this.plot_id));
        this.plot_chart.setOption(this.option);
        
        // update the date
        $('#' + this.plot_id + '_last_update').html(data.date);
    },

    resize: function() {
        if (this.plot_chart == null) {

        } else {
            this.plot_chart.resize();
        }
    }
};

// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_cdtline_cntys.plot_id] = fig_cdtline_cntys;
}
var fig_testline_states = {
    plot_id: 'fig_testline_states',
    plot_type: 'echarts',
    plot_chart: null,
    data_file: 'usstate-data-dict-latest.json',
    
    dates: [],
    items: [],
    series: [],

    load: function() {
        $.get(
            './read_data_file',
            {fn:this.data_file, ver: Math.random()},
            function(data) {
                fig_testline_states.init(data);
            }, 'json'
        );
    },

    add_series_by_state: function(state) {
        // check if this exist
        for (let i = 0; i < this.series.length; i++) {
            const s = this.series[i];
            if (s.name == state) {
                // oh, this has been added!
                return -1;
            }
        }
        var data = {
            name: state,
            data: this.data.dates.map(function(v) {
                var tpr = fig_testline_states.data.data[state][v].test_tpr_4dm;
                if (tpr != null) {
                    return (tpr * 100).toFixed(1);
                } else {
                    return null;
                }
            })
        };
        this.add_series(data);
    },

    /*
     data is {
         name: 'xxx',
         data: [1,2,3]
     }
     */
    add_series: function(data) {
        data.symbol = 'rect';
        data.symbolSize = 2;
        data.type = 'line';
        data.smooth = true;
        data.lineStyle = {
            width: 1,
            type: 'solid'
        };
        data.markPoint = {
            label: {
                fontSize: 10,
                color: 'white'
            },
            data: [
                {
                    type: 'max', name: 'Max',
                    symbolSize: 45,
                }
            ]
        }
        // update option
        this.series.push(data);
        this.option.series = this.series;
        this.items.push(data.name);
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    reset_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);

        // var defaults = ['AZ', 'FL', 'MN'];
        // for (let i = 0; i < defaults.length; i++) {
        //     const state = defaults[i];
        //     this.add_series_by_state(state);
        // }
    },

    clear_all_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;
        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    init: function(data) {
        this.data = data;
        this.dates = data.dates;
        this.items = [];
        this.series = [];

        this.option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            grid: {
                top: 30,
                right: 20,
                bottom: 20,
                left: 40
            },
            legend: {
                data: this.items,
                left: 75,
                right: 5,
                itemWidth: 20,
                textStyle: {
                    fontSize: 9
                }
            },
            xAxis: {
                type: 'category',
                data: this.dates
            },
            yAxis: {
                name: 'Pos.Rate(%)',
                type: 'value'
            },
            series: this.series
        };

        this.plot_chart = echarts.init(document.getElementById(this.plot_id));
        this.plot_chart.setOption(this.option);
        
        // update the date
        $('#' + this.plot_id + '_last_update').html(data.date);
    },

    resize: function() {
        if (this.plot_chart == null) {

        } else {
            this.plot_chart.resize();
        }
    }
};

// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_testline_states.plot_id] = fig_testline_states;
}
var fig_deathline_nations = {
    plot_id: 'fig_deathline_nations',
    plot_type: 'echarts',
    plot_chart: null,
    data_file: 'world-data-latest.json',

    fmt_comma: d3.format(","),
    
    dates: [],
    items: [],
    series: [],

    load: function() {
        $.get(
            './read_data_file',
            {fn:this.data_file, ver: Math.random()},
            function(data) {
                fig_deathline_nations.init(data);

                // use US as default
                fig_deathline_nations.add_series_by_nation('US')

            }, 'json'
        );
    },

    add_series_by_nation: function(nation) {
        // check if this exist
        for (let i = 0; i < this.series.length; i++) {
            const s = this.series[i];
            if (s.name == nation) {
                // oh, this has been added!
                return -1;
            }
        }
        var data = {
            name: nation,
            data: this.data.data[nation].cases.map(function(v, idx) {
                // return [idx+1, v];
                return [
                    v, 
                    fig_deathline_nations.data.data[nation].deaths[idx], 
                    fig_deathline_nations.data.data[nation].dates[idx]
                ];
            })
        };
        this.add_series(data);
    },

    /*
     data is {
         name: 'xxx',
         data: [1,2,3]
     }
     */
    add_series: function(data) {
        data.symbolSize = 2;
        data['type'] = 'line';
        data['smooth'] = true;
        data['lineStyle'] = {
            width: 1,
            type: 'solid'
        };
        // update option
        this.series.push(data);
        this.option.series = this.series;
        this.items.push(data.name);
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    reset_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;

        // leave only us
        this.add_series_by_nation('US');
    },

    clear_all_series: function() {
        // update option
        this.series = [];
        this.items = [];
        this.option.series = this.series;
        this.option.legend.data = this.items;

        // update chart
        this.plot_chart.setOption(this.option, true);
    },

    init: function(data) {
        this.data = data;
        this.dates = data.dates;
        this.items = [];
        this.series = [];

        this.option = {
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    // console.log(params);
                    var str = '';
                    for (let i = 0; i < params.length; i++) {
                        const param = params[i];
                        str += param.seriesName + ' on ' + param.value[2] + '<br>' +
                            'Total cases: ' + fig_caseline_nations.fmt_comma(param.value[0]) + '<br>' + 
                            'Deaths: ' + fig_caseline_nations.fmt_comma(param.value[1]) + '<br>';
                    }
                    return str;
                }
            },
            grid: {
                top: 30,
                right: 25,
                bottom: 33,
                left: 60
            },
            legend: {
                data: this.items,
                left: 95,
                right: 5,
                itemWidth: 20,
                textStyle: {
                    fontSize: 9
                }
            },
            xAxis: {
                name: 'Total cases',
                type: 'log',
                nameGap: 20,
                nameLocation: 'center'
            },
            yAxis: {
                name: 'Cum.Deaths',
                type: 'log',
                min: 1
            },
            series: this.series
        };

        this.plot_chart = echarts.init(document.getElementById(this.plot_id));
        this.plot_chart.setOption(this.option);
        
        // update the date
        $('#' + this.plot_id + '_last_update').html(data.date);
    },

    resize: function() {
        if (this.plot_chart == null) {

        } else {
            this.plot_chart.resize();
        }
    }
};

// bind this to the global plots object
if (typeof(plots) == 'undefined') {

} else {
    plots[fig_deathline_nations.plot_id] = fig_deathline_nations;
}


// the data options
var plots_options = {
    selected: 'doubling_analysis_result',
    filetypes: {
        'doubling_analysis_result': {
            type: 'doubling_analysis_result',
            desc: '<b>Doubling Time Analysis</b> (e.g., doubling_xxxx_3_30.xlsx, for plotting the animation lines)',
            tags: [{
                tag: 'countylevel',
                desc: '<b>County Level</b> (e.g., doubling_counties_3_30.xlsx, for plotting the heatmap of doubling time of counties)'
            }, {
                tag: 'mayosys',
                desc: '<b>Mayo Related</b> (e.g., doubling_mayosys_03_31.xls'
            }, {
                tag: 'word',
                desc: '<b>World Countries</b> (e.g., doubling_world_03_31.xls'
            }]
        },
        'trendline_past7d': {
            type: 'trendline_past7d',
            desc: '<b>Trends lines of cases vs past7day cases</b> (e.g., trpast7d_xxxx_3_30.xlsx, for plotting the heatmaps)',
            tags: [{
                tag: 'countylevel',
                desc: '<b>County Level</b> Trend Lines of Total vs Past 7 days</b>'
            }]
        }
    }
};


var jarvis = {

    name2color_map: d3.map(),

    getUrlParameter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    },

    init: function() {
        /*
        rgs format:
        region_name,FIPS,FIPS,FIPS,FIPS|region_name,FIPS,FIPS        
        */
        var rgs = jarvis.getUrlParameter('rgs');
        this.regions = [];
        if (rgs != null) {
            var tmp = rgs.split('|');
            for (let i = 0; i < tmp.length; i++) {
                const reg = tmp[i];
                tmp2 = reg.split(',');
                var region_name = tmp2[0];
                var r = {
                    name: region_name,
                    fips_list: []
                }
                for (let j = 1; j < tmp2.length; j++) {
                    const fips = tmp2[j];
                    r.fips_list.push(fips);
                }
                this.regions.push(r);
            }
        } else {
            this.regions = [{
                name: 'RST', fips_list: ['27099', '27109', '27139', '27169']
            }]
        }

        // load all the data needed for county level and state level
        $.when(
            $.get('./covid_data/' + figmker_cdtmap.data_file, {ver: Math.random()}),
            $.get('./static/data/us-countymap-5m.json', {}),
            $.get('./covid_data/' + fig_caseline_states.data_file, {ver: Math.random()}),
            $.get('./covid_data/' + fig_heatmap_usstatecdt.data_file, {ver: Math.random()}),
        ).done(function(data1, data2, data3, data4) {
            vue_rgpanels.init(data1[0], jarvis.regions);
            figmker_cdtmap.init(data1[0]);
            // init each region's figures
            for (let i = 0; i < jarvis.regions.length; i++) {
                const region = jarvis.regions[i];
                
                // make map
                var plot_id = 'fig_cdtmap_' + region.name;
                var fig_cdtmap = figmker_cdtmap.make_fig(region, plot_id, data1[0]);
                plots[fig_cdtmap.plot_id] = fig_cdtmap;

                // make case line
                plot_id = 'fig_caseline_' + region.name;
                var fig_caseline = figmker_caseline.make_fig(region, plot_id, data1[0]);
                plots[fig_caseline.plot_id] = fig_caseline;

                // make death line
                plot_id = 'fig_deathline_' + region.name;
                var fig_deathline = figmker_deathline.make_fig(region, plot_id, data1[0]);
                plots[fig_deathline.plot_id] = fig_deathline;
            }

            // draw the county map
            fig_heatmap_uscntycdt.set_all_counties(data2[0]);
            fig_heatmap_uscntycdt.init(data1[0]);
            
            // draw the county case death line
            fig_casedeathline_cntys.init(data1[0]);
            fig_casedeathline_cntys.add_series_by_FIPS('04013'); // Maricopa,AZ

            // draw the county cdt line
            fig_cdtline_cntys.init(data1[0]);
            fig_cdtline_cntys.add_series_by_FIPS('04013'); // Maricopa,AZ

            // draw the state plots
            fig_caseline_states.init(data3[0]);
            fig_testline_states.init(data3[0]);
            fig_heatmap_usstatecdt.init(data4[0]);
            
            fig_caseline_states.add_series_by_state('MN');
            fig_testline_states.add_series_by_state('MN');
            
            // hide the start screen after loading most of data
            jarvis.ssmsg('Dashboard is initialized.')
            setTimeout('jarvis.ssclose();', 500);
        });

        // draw world map and related plots
        $.get(
            './covid_data/' + fig_heatmap_worldcdt.data_file,
            {ver: Math.random()},
            function(data) {
                fig_heatmap_worldcdt.init(data);
                fig_caseline_nations.init(data);
                fig_deathline_nations.init(data);

                fig_caseline_nations.add_series_by_nation('US');
                fig_deathline_nations.add_series_by_nation('US');
            }
        )

        // draw the update date
        $.get(
            './covid_data/last_update.json?ver=' + Math.random(),
            {},
            function(data) {
                jarvis.set_last_update(data);
            }, 'json'
        );

        // add resize
        $(window).on('resize', function(){
            for (const plot_id in plots) {
                if (plots.hasOwnProperty(plot_id)) {
                    const fig = plots[plot_id];
                    if (fig.hasOwnProperty('resize')) {
                        fig.resize();
                    }
                }
            }
        });

    },

    get_color_by_name: function (name) {
        var name_upper = name.toUpperCase();
        if (this.sp_item_settings.hasOwnProperty(name_upper)) {
            return this.sp_item_settings[name_upper].color;
        } else {
            if (this.name2color_map.has(name_upper)) {
                return this.name2color_map.get(name_upper);
            } else {
                var idx = this.name2color_map.keys().length % 10;
                var color = d3.schemeCategory10[idx];
                this.name2color_map.set(name_upper, color);
                return color;
            }
        }
    },

    guess_width: function(elem_id) {
        for (let i = 0; i < this.page_columns.length; i++) {
            const col_id = this.page_columns[i];
            if (document.getElementById(col_id).contains(document.getElementById(elem_id))) {
                var w = document.getElementById(col_id).getBoundingClientRect().width;
                console.log('* JARVIS: I guess the width of ' + elem_id + ' is ' + w);
                return w;
            }
        }

        return 0;
    },

    calc_color_by_name: function (name, alpha) {
        var name_upper = name.toUpperCase();
        if (typeof (alpha) == 'undefined') { alpha = 1; }
        var r = (name_upper.charCodeAt(0) - 64) / 26 * 255;
        var g = name_upper.charCodeAt(1) / 26 * 255;
        var b = 0;
        if (name_upper.length > 2) {
            for (var i = 2; i < name_upper.length; i++) {
                b += name_upper.charCodeAt(i);
            }
            b = b / (name_upper.length - 2);
        }
        return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
    },

    set_last_update: function(data) {
        $('.last_update').html(data.last_update);
        $('.last_update_date').html(data.last_update.split(' ')[0]);
    },

    /*
     * Where using this function, make sure fig_heatmap_uscntycdt is loaded.
     */
     add_county_series: function(FIPS) {
        console.log('* add county ' + FIPS);
        // get basic info
        var data = fig_heatmap_uscntycdt.data_dict.get(FIPS);
        if (data == null) {
            // which means this FIPS didn't have case
            return -1;
        }
        if (data.nccs[data.nccs.length-1] == 0) {
            // means this county has no case
            return -1;
        }
        // prepare data ?

        // update chart
        fig_casedeathline_cntys.add_series_by_FIPS(FIPS);
        fig_cdtline_cntys.add_series_by_FIPS(FIPS);

    },

    add_state_series: function(state) {
        console.log('* add state ' + state);
        fig_caseline_states.add_series_by_state(state);
        fig_testline_states.add_series_by_state(state);
    },

    add_nation_series: function(nation) {
        console.log('* add nation ' + nation);
        fig_caseline_nations.add_series_by_nation(nation);
        fig_deathline_nations.add_series_by_nation(nation);
    },

    google_search: function(keywords) {
        var url = 'https://www.google.com/search?q=' + keywords.join('+');
        window.open(url);
    }
};


$(document).ready(function () {
    jarvis.init();
})
</script>
</body>

</html>